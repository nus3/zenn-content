---
title: "Next.jsã§ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è€ƒãˆã‚‹"
emoji: "ğŸ™Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["typescript", "nextjs"]
published: false
---

## Next.js ã§ error ã‚’ throw ã™ã‚‹ã¨ã©ã†ãªã‚‹ã‹

https://zenn.dev/nus3/scraps/3069a458562eca#comment-72ecff69ed2928

## React ã® Error Boundary ã¨ã¯

[å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://ja.reactjs.org/docs/error-boundaries.html)

- å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ã‚’ catch ã—ã¦ä»£ã‚ã‚Šã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦ãã‚Œã‚‹
- class ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®å®Ÿè£…
  - functional ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§å®Ÿè£…ã§ãã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã‚ã‚‹(star æ•°å°‘ãªã‚)
- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã®ã‚¨ãƒ©ãƒ¼ã¯ catch ã—ãªã„

### ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…

```tsx
class ErrorBoundary extends Component<Props, State> {
  public state: State = {
    hasError: false,
  };

  public static getDerivedStateFromError(_: Error): State {
    // Update state so the next render will show the fallback UI.
    return { hasError: true };
  }

  public componentDidCatch(error: Error, errorInfo: ErrorInfo): void {
    console.error("Uncaught error:", error, errorInfo);
  }

  public render(): JSX.Element | ReactNode {
    if (this.state.hasError) {
      return <h1>ã‚„ã¹ã¹ã¹ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¡ã‚ƒã£ãŸã‚ˆ</h1>;
    }

    return this.props.children;
  }
}
```

```tsx:_app.tsx
const MyApp: NextPage<AppProps> = ({ Component, pageProps }: AppProps) => {

  return (
    <ErrorBoundary>
      <Component {...pageProps} />
    </ErrorBoundary>
  )
}
```

#### ErrorBoundary ãŒè¡¨ç¤ºã•ã‚Œã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³

ã¾ãã“ã‚“ãªã“ã¨ã¯ãªã„ã‘ã©ã‚‚
å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒ error ã‚’ throw ã—ãŸæ™‚

```tsx
const TestErrorPage: NextPage = () => {
  throw new Error("ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ã ã‚ˆ");

  return (
    <div style={{ padding: "30px" }}>
      <h1>errorã®å‹•ä½œç¢ºèª</h1>
      <button type="button" onClick={handleError}>
        ç¢ºèª
      </button>
    </div>
  );
};
```

ts ã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã¯ãšãªã®ã§åŸºæœ¬çš„ã«ã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§ã®ã‚¨ãƒ©ãƒ¼ã¯ throw ã•ã‚Œãªã„ã¯ãšã ãŒ
**api ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‹ãŒæƒ³å®šã•ã‚Œã¦ã„ãªã„ã‚‚ã®ã«ãªã£ã¦ã„ã‚‹å ´åˆãªã©**å¯èƒ½æ€§ã¯ã‚ã‚‹
ä¾‹ : é…åˆ—ã‚’è¿”ã—ã¦ãã‚Œã‚‹ã¯ãšãŒ string ã«ãªã£ã¦ã„ã‚‹(ã“ã®å ´åˆ`Array.prototype.map()`ãªã©é…åˆ—æƒ³å®šã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹)

#### ErrorBoundary ãŒè¡¨ç¤ºã•ã‚Œãªã„ãƒ‘ã‚¿ãƒ¼ãƒ³

ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©å†…ã§ã‚¨ãƒ©ãƒ¼ã‚’ throw ã—ãŸæ™‚

```tsx
const TestErrorPage: NextPage = () => {
  const handleError = () => {
    throw new Error("ãƒ†ã‚¹ãƒˆ");
  };

  return (
    <div style={{ padding: "30px" }}>
      <h1>errorã®å‹•ä½œç¢ºèª</h1>
      <button type="button" onClick={handleError}>
        ç¢ºèª
      </button>
    </div>
  );
};
```

ç¢ºèªãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚‚ console ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã ã‘

## Next.js ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸

[å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://nextjs.org/docs/advanced-features/custom-error-page#404-page)

- Next.js ã®`_error.tsx`ãŒ ErrorBoundary ã®ä»£ã‚ã‚Šã‚’ã—ã¦ãã‚Œãã†
- 404.tsx ã¯åˆ¥é€”ä½œã£ãŸæ–¹ãŒè‰¯ã•ãã†
- getInitialProps ã§ page ãŒ load ã•ã‚Œã‚‹ã¨ãã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒå®šç¾©ã§ãã‚‹

### ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…

```tsx:_error.tsx
type ErrorProps = {
  statusCode: number
}

const Error: NextPage<ErrorProps> = ({ statusCode }: ErrorProps) => {
  return (
    <p>
      {statusCode
        ? `An error ${statusCode} occurred on server`
        : 'An error occurred on client'}
    </p>
  )
}

Error.getInitialProps = ({ res, err }: NextPageContext) => {
  const statusCode = res ? res.statusCode : err ? err.statusCode : 404
  return { statusCode }
}
```

## ã¾ã¨ã‚

- Error Boundary ã§æ‹¾ã£ã¦ãã‚Œã‚‹ã‚¨ãƒ©ãƒ¼ã¯ `pages/_error.tsx` ã‚‚æ‹¾ã£ã¦ãã‚Œãã†ãªã®ã§ Next ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«å¯„ã›ã‚‹ã§è‰¯ã•ãã†
- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©å†…ã®ã‚¨ãƒ©ãƒ¼ã¯åˆ¥é€”æ–¹é‡ã‚’æ±ºã‚ã‚‹å¿…è¦ãŒã‚ã‚‹(ä¾‹: axios ã§ Error å±¥ã„ãŸã‚‰ç‰¹å®šã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹ãªã©)
