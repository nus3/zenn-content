---
title: "FormikとReact Hook Formを実装してみて"
emoji: "✨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["react", "typescript", "formik", "reacthookform", "nextjs"]
published: false
---

## はじめに

Formik を使ってたけど form のライブラリって今いいのあるんだっけかと思ったら
hook があったので実装の違いを確認することにした

## 概要

レンダリング回数やパフォーマンスの計測はしてませぬ
あくまで実装の違いのみ

## 環境

```json:package.json
{
  "dependencies": {
    "formik": "2.2.6",
    "next": "10.0.3",
    "react": "17.0.1",
    "react-dom": "17.0.1",
    "yup": "0.32.8"
  }
}
```

## Formik

### インストール

1. `yarn add formik yup`
2. `yarn add -D @types/yup`

### 基本

`useFormik`を使った hook での書き方と`<Formik />`や`<Field />`を使ったコンポーネントでの書き方二つある

hook を使った書き方は[チュートリアルのコード](https://formik.org/docs/tutorial#a-simple-newsletter-signup-form)を参考に。
今回は慣れ親しんだコンポーネントでの書き方を記載する

一つの form を presenter と container と`<Formik />`コンポーネントを定義する部分の三つに分ける
それぞれざっくり下記の役割

- presenter→form の ui
- container→useEffect とか副作用
- `<Formik />`

#### presenter

[チュートリアルから抜粋](https://formik.org/docs/tutorial#leveraging-react-context)
Form や Field は formik から import したもの

```tsx
export type ExampleFormValues = {
  firstName: string;
  lastName: string;
  email: string;
};

export const ExampleFormPresenter = (): JSX.Element => (
  <Form>
    <label htmlFor="firstName">First Name</label>
    <Field name="firstName" type="text" />
    <ErrorMessage name="firstName" />
    <label htmlFor="lastName">Last Name</label>
    <Field name="lastName" type="text" />
    <ErrorMessage name="lastName" />
    <label htmlFor="email">Email Address</label>
    <Field name="email" type="email" />
    <ErrorMessage name="email" />
    <button type="submit">Submit</button>
  </Form>
);
```

#### container

例)親コンポーネント側で props を通じて form の値を変えたい時

```tsx
export type ExampleFormContainerProps = {
  formValues?: ExampleFormValues;
};

export const ExampleFormContainer = ({
  formValues,
}: ExampleFormContainerProps): JSX.Element => {
  const { setValues } = useFormikContext<ExampleFormValues>();

  useEffect(() => {
    setValues(formValues);
  }, [formValues]);

  return <ExampleFormPresenter />;
};
```

#### <Formik />

container を`<Formik />`でラップする

```tsx
export type ExampleFormProps = {
  handleSubmit: (values: ExampleFormValues) => void;
  formValues?: ExampleFormValues;
};

export const ExampleForm = ({
  handleSubmit,
  formValues,
}: ExampleFormProps): JSX.Element => {
  const onSubmit = (values: ExampleFormValues) => {
    handleSubmit(values);
  };

  const initialValues: ExampleFormValues = formValues || {
    firstName: '';
    lastName: '';
    email: '';
  };

  return (
    <Formik
      initialValues={initialValues}
      onSubmit={onSubmit}
    >
      <ExampleFormContainer formValues={formValues} />
    </Formik>
  );
};
```

### バリデーション

[独自にバリデーションのルールを定義できる](https://formik.org/docs/guides/validation#validate)
が、ある程度汎用的なルールはあるものを使いたいので Yup が使える[validationSchema](https://formik.org/docs/guides/validation#validate)の実装例を記載する

[yup のバリデーションルール一覧](https://github.com/jquense/yup#api)

Formik の validationSchema(prop) に yup で定義したバリデーションルールを入れる感じ

```tsx
import * as Yup from "yup";

export const validationSchema = Yup.object().shape({
  firstName: Yup.string().required(),
  lastName: Yup.string().required(),
  email: Yup.string().email(),
});

export const ExampleForm = ({
  // ....省略
}: ExampleFormProps): JSX.Element => {
  // ....省略
  return (
    <Formik
      validationSchema={validationSchema}
    >
    // ....省略
  );
};
```

#### エラーメッセージの日本語化

このままだとバリデーションに引っ掛かった時のエラーメッセージを日本語化する
setLocal の中のオブジェクトのプロパティは[ここ](https://github.com/jquense/yup#api)を参照

```tsx
import { setLocale } from "yup";
setLocale({
  mixed: {
    required: () => `入力必須項目です。`,
  },
  string: {
    min: ({ min }) => `${min}文字以上で入力して下さい。`,
  },
});
```

#### Yup でカスタムバリデーションの定義

`test('testの名前', 'エラーメッセージ', (value): boolean => {カスタムバリデーションの定義})`
value は直前の型に影響される(string()なら string になる)

例)文字列が`YYYY/MM/DD`になっているかどうか

```tsx
const validationSchema = Yup.object().shape({
  date: Yup.string()
    .required()
    .test("checkDateFormat", "日付の形式が間違ってます", (value): boolean => {
      if (!dayjs(value).isValid()) return false;
      const format = "YYYY/MM/DD";
      return dayjs(value, format).format(format) === value;
    }),
});
```

#### FieldArray

同一 name の input に配列入れたい時に使うやつ
[formik ドキュメントの該当箇所](https://formik.org/docs/api/fieldarray#fieldarray-array-of-objects)

実装例

```tsx
type Friend = {
  name: string;
  email: string;
};

export type ExampleFormValues = {
  friends: Friend[];
};

// ...省略
<Field name="friends">
  {({ field }: FieldProps<ExampleFormValues["friends"]>) => (
    <FieldArray name={field.name}>
      {({ remove, push }: ArrayHelpers) => (
        <div>
          {field.value.map((f, i) => (
            <div key={i}>
              <div>
                <InputText
                  name={`friends.${i}.name`}
                  value={f.name}
                  onChange={field.onChange}
                />
                <ErrorMessage name={`friends.${i}.name`} />
              </div>
              <div>
                <InputText
                  name={`friends.${i}.email`}
                  value={f.email}
                  onChange={field.onChange}
                />
                <ErrorMessage name={`friends.${i}.email`} />
              </div>
              <button
                type="button"
                onClick={() => {
                  remove(i);
                }}
              >
                削除
              </button>
            </div>
          ))}
          <button
            type="button"
            onClick={() => {
              push({ name: "", email: "" });
            }}
          >
            友達追加
          </button>
        </div>
      )}
    </FieldArray>
  )}
</Field>;
```

ArrayHelpers が list を扱う上で便利な helper 用意してくれてる

## React Hook Form

### 基本

### バリデーション
