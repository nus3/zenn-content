---
title: "Next.jsã«Reduxã‚’å®Ÿè£…ã—ã¦ã¿ã¦"
emoji: "ğŸ› ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["react", "typescript", "redux", "nextjs"]
published: true
---

## ã¯ã˜ã‚ã«

æ–°ã—ã„ Next.js ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã€ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãªã© page å±¤ã‚’ã¾ãŸãå€¤ã‚’æ ¼ç´ã™ã‚‹ Store ã‚’å°å…¥ã—ãŸãã€Redux ã‚’è§¦ã£ã¦ã¿ãŸ
é–“é•ã„ã‚„ã‚‚ã£ã¨ã„ã„æ–¹æ³•ãŒã‚ã‚‹å ´åˆã¯ã©ã—ã©ã—ã”æŒ‡æ‘˜ãã ã•ã„ã¾ã›

## è¨˜äº‹ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ

- Redux ã‚’å°å…¥ã—ã‚ˆã†ã¨ã—ã¦ã‚‹äºº
- åŸºæœ¬ã¯ page ã§ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç†ã™ã‚‹ã‘ã©ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªæƒ…å ±ã ã‘ store ã‚’ä½¿ã„ãŸã„(ãƒ©ã‚¤ãƒˆã« redux ä½¿ã„ãŸã„)äºº

## æ¦‚è¦

ã–ã£ãã‚Šã‚¤ãƒ¡ãƒ¼ã‚¸

- @reduxjs/toolkit ã§ state ã®ç®¡ç†
- react-redux ã§ react ã¨ bind ã—ã¦ã‚‹

## ç’°å¢ƒ

Redux(+localStorage ã¨ãƒã‚¤ãƒ³ãƒ‰ã•ã›ã‚‹ãŸã‚ã«)ã‚’å…¥ã‚Œã‚‹ãŸã‚ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚‚ã®

1. `yarn add @reduxjs/toolkit redux-persist react-redux`
2. `yarn add -D @types/react-redux`

```json:package.json
{
  "dependencies": {
    "@reduxjs/toolkit": "1.5.0",
    "next": "10.0.3",
    "react": "17.0.1",
    "react-dom": "17.0.1",
    "react-hook-form": "6.14.0",
    "react-redux": "7.2.2",
    "redux-persist": "6.0.0"
  },
  "devDependencies": {
    "@types/react-redux": "7.1.15",
  }
}
```

[redux-persist](https://github.com/rt2zz/redux-persist)ã®æœ€æ–°ã‚³ãƒŸãƒƒãƒˆãŒçµæ§‹å¤ãã¦è‹¥å¹²æ€–ã„ã‘ã© star æ•°ã‚‚å¤šã„ã—ã€[Next.js ã® examples](https://github.com/vercel/next.js/tree/canary/examples/with-redux-persist)ã‚‚ã‚ã£ãŸã®ã§å°å…¥ã€‚ã„ã–ã¨ãªã‚Œã°è‡ªä½œã™ã‚‹ãã‚‰ã„ã®ãŠæ°—æŒã¡ã€‚

[Redux ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://redux.js.org/introduction/getting-started)ã‚’è¦‹ã‚‹ã¨ Redux Toolkit ã‚¤ã‚¤ãƒ¨ï¼ã£ã¦ãŠå‹§ã‚ã•ã‚Œã¦ãŸã‹ã‚‰ Redux Toolkit ã‚’ä½¿ã†ã“ã¨ã«ã—ãŸ

> Whether you're a brand new Redux user setting up your first project, or an experienced user who wants to simplify an existing application, Redux Toolkit can help you make your Redux code better.

## store(Redux) ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ(å‚è€ƒ)

- redux-way
- ducks
- re-ducks

ãŒã‚ã‚‹ã‚‰ã—ã„
https://superhahnah.com/redux-directory-petterns/

Redux Toolkit ä½¿ã†ã®ã§ãã‚‚ãã‚‚ã‚³ãƒ¼ãƒ‰ã®è¨˜è¿°é‡ãŒæ¸›ã‚‹ã®ã¨ã‚ãã¾ã§ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã®ã¿ã‚’ store ã§ç®¡ç†ã™ã‚‹äºˆå®šãªã®ã§`store.ts`ã® 1 ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚ã„ã„ã‹ã‚‚ã¨æ€ã£ãŸ(store ã¯ã“ã‚Œã¾ã§ã‚‚ã“ã‚Œã‹ã‚‰ã‚‚æ‹¡å¤§ã—ãªã„ã‚ˆã®æ„ã‚’ 1 ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹ã“ã¨ã§è¡¨ã™)

## ã„ã–å®Ÿè£…

### slice ã‚’ä½œã‚Šã¾ã™

```typescript:src/store/user/index.ts
import { createSlice, PayloadAction } from '@reduxjs/toolkit'

export type User = {
  name: string | null
  age: number | null
  email: string | null
  token: string | null
  history: string[]
}

export type UserState = {
  user: User
}

export type UpdateUserPayload = User
export type AddHistoryPayload = string

const initialState: UserState = {
  user: {
    name: null,
    age: null,
    email: null,
    token: null,
    history: [],
  },
}

export const userSlice = createSlice({
  name: 'user',
  initialState,
  // HACK: reducerã¯è‚¥å¤§åŒ–ã—ãŸã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åˆ†ã‘ãŸããªã‚‹ã‹ã‚‚
  reducers: {
    updateUser(state, action: PayloadAction<UpdateUserPayload>) {
      state.user = action.payload
    },
    addHistory(state, action: PayloadAction<AddHistoryPayload>) {
      state.user.history.push(action.payload)
    },
    reset(): UserState {
      return initialState
    },
  },
})
```

### store ä½œã‚Šã¾ã™

ã“ã“ã§ persist ã®è¨­å®šã‚‚ã—ã¡ã‚ƒã†
Redux Toolkit ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å¤§ã„ã«å‚è€ƒã«ã•ã›ã¦ã„ãŸã ã
https://redux-toolkit.js.org/usage/usage-guide#use-with-redux-persist

```typescript:src/store/index.ts
import {
  configureStore,
  getDefaultMiddleware,
  combineReducers,
  EnhancedStore,
} from '@reduxjs/toolkit'
import { userSlice } from 'store/user'
import {
  persistReducer,
  FLUSH,
  REHYDRATE,
  PAUSE,
  PERSIST,
  PURGE,
  REGISTER,
} from 'redux-persist'
import createWebStorage from 'redux-persist/lib/storage/createWebStorage'

// HACK: `redux-persist failed to create sync storage. falling back to noop storage.`ã®å¯¾å¿œ
// https://github.com/vercel/next.js/discussions/15687#discussioncomment-45319
const createNoopStorage = () => {
  return {
    getItem(_key) {
      return Promise.resolve(null)
    },
    setItem(_key, value) {
      return Promise.resolve(value)
    },
    removeItem(_key) {
      return Promise.resolve()
    },
  }
}
const storage =
  typeof window !== 'undefined'
    ? createWebStorage('local')
    : createNoopStorage()

const rootReducer = combineReducers({
  user: userSlice.reducer,
})

export type RootState = ReturnType<typeof rootReducer>

const persistConfig = {
  key: 'p-next-test',
  version: 1,
  storage,
}
const persistedReducer = persistReducer(persistConfig, rootReducer)

export const useStore = (): EnhancedStore => {
  return configureStore({
    reducer: persistedReducer,
    middleware: getDefaultMiddleware({
      serializableCheck: {
        ignoredActions: [FLUSH, REHYDRATE, PAUSE, PERSIST, PURGE, REGISTER],
      },
    }),
  })
}
```

persistConfig ã‚’ä½œã‚‹æ™‚ã« storage ã‚’å…¥ã‚Œã‚‹ã‚“ã ã‘ã©ã‚‚ redux-persist ã® v6 ã ã¨ yarn dev ã—ãŸéš›ã«`redux-persist failed to create sync storage. falling back to noop storage.`ã£ã¦è¨€ã‚ã‚Œã‚‹
[ä¸€æ™‚çš„ã«ã¯ã“ã®å¯¾å¿œ](https://github.com/vercel/next.js/discussions/15687#discussioncomment-45319)ã§æ–‡å¥ã¯è¨€ã‚ã‚Œãªããªã‚‹

### \_app.tsx ã§ store ã‚’å‘¼ã³ã¾ã™

```typescript:src/pages/_app.tsx
import { AppProps } from 'next/app'
import { Provider } from 'react-redux'
import { persistStore } from 'redux-persist'
import { PersistGate } from 'redux-persist/integration/react'
import { useStore } from 'store'

const MyApp = ({ Component, pageProps }: AppProps): JSX.Element => {
  const store = useStore()
  const persistor = persistStore(store)

  return (
    <Provider store={store}>
      <PersistGate persistor={persistor}>
        <Component {...pageProps} />
      </PersistGate>
    </Provider>
  )
}

export default MyApp
```

@reduxjs/toolkit ãŒ Provider ãªã‚‹ã‚‚ã®ç”¨æ„ã—ã¦ãã‚Œã¦ã‚‹ã®ã‹ã¨æ€ãˆã°ãã†ã§ã¯ãªã react-redux ãŒå¿…è¦ãªã®ãŒã“ã‚“ãŒã‚‰ãŒã‚Šãƒã‚¤ãƒ³ãƒˆ

### store ã«å€¤ã‚’æ ¼ç´ã—ãŸã‚Šã€å–å¾—ã—ãŸã‚Š

```typescript: src/pages/index.tsx
import { useDispatch, useSelector } from 'react-redux'
import { RootState } from 'store'
import { userSlice } from 'store/user'


const StorePage = (): JSX.Element => {
  const dispatch = useDispatch()
  const user = useSelector((state: RootState) => state.user)

  const handleConfirm = () => {
    // eslint-disable-next-line
    console.log(user)
  }
  const handleUpdate = () => {
    dispatch(
      userSlice.actions.updateUser({
        name: 'name',
        age: 28,
        email: 'email',
        token: 'token',
        history: [],
      })
    )
  }
  const handleReset = () => {
    dispatch(userSlice.actions.reset())
  }
  const handleAddHistory = () => {
    dispatch(userSlice.actions.addHistory('push'))
  }

  return (
    <div>
      <h1>storeã®å‹•ä½œç¢ºèª</h1>
      <button type="button" onClick={handleConfirm}>
        ç¢ºèª
      </button>
      <button type="button" onClick={handleUpdate}>
        update
      </button>
      <button type="button" onClick={handleReset}>
        reset
      </button>
      <button type="button" onClick={handleAddHistory}>
        addHistory
      </button>
    </div>
  )
}

export default StorePage
```

react-redux ã® useSelector ã§ state ã‚’å–å¾—ã—ã¦ã€useDispatch ã§ action ã‚’å‘¼ã³å‡ºã™æ„Ÿã˜
