---
title: "Jestã®ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ãŠæ‰‹è»½ã«ãƒã‚§ãƒƒã‚¯ã™ã‚‹"
emoji: "ğŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["jest"]
published: true
---

## çµè«–

- Jestã¯å®Ÿè¡Œæ™‚ã«`--coverageReporters=json-summary`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚‹ã“ã¨ã§summaryã®jsonã‚’å‡ºåŠ›ã—ã¦ãã‚Œã‚‹
- summaryã®jsonã‹ã‚‰totalã®percentã‚’å–å¾—ã§ãã‚‹
- totalã®percentã‚’åŸºã«ç°¡æ˜“çš„ãªã‚«ãƒãƒ¬ãƒƒã‚¸ã®ã—ãã„å€¤ãƒã‚§ãƒƒã‚¯ãŒã§ãã‚‹!

## ã¯ã˜ã‚ã«

ãµã¨æ€¥ã«ã€circleciä¸Šã§**ãŠæ‰‹è»½**ã«ã‚«ãƒãƒ¬ãƒƒã‚¸ã®ã—ãã„å€¤ãƒã‚§ãƒƒã‚¯ãŒã—ãŸããªã£ãŸ

[circleciã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://circleci.com/docs/ja/2.0/code-coverage/#codecov)ã«æ›¸ã„ã¦ã‚ã‚‹ãŒã€ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ç”¨ã«ä¾¿åˆ©ãªæ©Ÿèƒ½ãŒåŒ…æ‹¬ã•ã‚ŒãŸè‰¯ã•ã’ãªã‚µãƒ¼ãƒ“ã‚¹ã«ãŠä»»ã›ã™ã‚Œã°ã‚„ã‚ŠãŸã„ã“ã¨ã¯ã§ããã†ã ã£ãŸãŒã€Jestã ã‘ã§æ°—è»½ã«ã§ããªã„ã‹ã—ã‚‰ã¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³èª¿ã¹ã¦ãŸã‚‰[è‰¯ã•ã’ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³](https://jestjs.io/ja/docs/configuration#coveragereporters-arraystring--string-options)ãŒã‚ã£ãŸã®ã§ã€ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã€ã—ãã„å€¤ãƒã‚§ãƒƒã‚¯ã®scriptã‚’ä½œã‚‹ã“ã¨ã«ã—ãŸ

## è¨˜äº‹ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ

- Jestã§**ç°¡å˜ãª**[^1]ã‚«ãƒãƒ¬ãƒƒã‚¸ã®ãƒã‚§ãƒƒã‚¯ãŒã—ãŸã„äºº

[^1]: ã“ã“ã§è¨€ã†`ç°¡å˜ãª` ã¨ã¯ã€Statementsã‚„Branchesã€Functionsã®totalã®ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆãŒä¸€å®šã®å€¤ã‚’ä¸‹å›ã£ã¦ãªã„ã‹CIã§è»½ããƒã‚§ãƒƒã‚¯ã—ãŸã„ãã‚‰ã„ã®æ¸©åº¦æ„Ÿã‚’æŒ‡ã—ã¦ã„ã¾ã™

## ç’°å¢ƒ

```json:package.json
{
  "devDependencies": {
    "jest": "26.6.3",
    "ts-node": "10.2.1",
    "typescript": "4.4.3",
  }
}
```

## ã‚«ãƒãƒ¬ãƒƒã‚¸ã®çµæœã‚’jsonã«å‡ºåŠ›ã™ã‚‹

çµè«–ã§ã‚‚æ›¸ãã¾ã—ãŸãŒã€summaryã®çµæœã‚’å‡ºåŠ›ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¦Jestã‚’å®Ÿè¡Œã—ã¾ã™

```json:package.json
{
  "scripts": {
    "test-total-coverage": "jest --collectCoverage=true --coverageReporters=json-summary",
  }
}
```

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯`coverage/coverage-summary.json`ã«å‡ºåŠ›ã•ã‚Œã‚‹ã¯ãš

## ã—ãã„å€¤ãƒã‚§ãƒƒã‚¯ã®scriptã‚’ä½œã‚‹

1. `coverage/coverage-summary.json`ã®èª­ã¿è¾¼ã¿
2. ãƒã‚§ãƒƒã‚¯ã—ãŸã„é …ç›®ã®å€¤ã‚’å–å¾—
3. ã—ãã„å€¤ã‚ˆã‚Šä½ããªã„ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹

:::details coverage-summary.jsonã¯ã“ã‚“ãªæ„Ÿã˜

```json: coverage/coverage-summary.json
{
  "total": {
    "lines":{
      "total":1480,
      "covered":413,
      "skipped":0,
      "pct":27.91
    },
    "statements":{
      "total":1566,
      "covered":423,
      "skipped":0,
      "pct":27.01
    },
    "functions":{
      "total":594,
      "covered":193,
      "skipped":0,
      "pct":32.49
    },
    "branches":{
      "total":763,
      "covered":171,
      "skipped":0,
      "pct":22.41
    }
  },
  // ä»¥é™ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚„ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã®å€¤ãŒã¤ã‚‰ã¤ã‚‰ã¨å‡ºåŠ›ã•ã‚Œã‚‹
}
```

pctãŒä½ã„ã“ã¨ã«æ°—ã¥ã„ãŸãã‚“ãªæ„Ÿã®è‰¯ã„äººã¯ã‚­ãƒ©ã‚¤ã§ã™
:::


ä»Šå›ã¯Functionsã®ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆãŒ80%ã‚ˆã‚Šä¸‹å›ã£ãŸã‚‰CIãŒè½ã¡ã‚‹ã‚ˆã†ã«æ›¸ã„ã¦ã¿ã¾ã—ãŸ(é …ç›®ã¨ã—ãã„å€¤ã¯ãƒ†ã‚­ãƒˆã‚¦ã§ã™)

```typescript: scripts/check-coverage/index.ts
import { readFileSync } from 'fs'

// å‡ºåŠ›ã•ã‚Œã‚‹jsonã‚’è¦‹ã¦ã€å‹ã‚’ãŠæ°—æŒã¡ç¨‹åº¦ã«å®šç¾©
type CoverageColumn = {
  total: number
  covered: number
  skipped: number
  pct: number
}
type CoverageType = 'lines' | 'statements' | 'functions' | 'branches'
type CoverageValue = { [key in CoverageType]: CoverageColumn }
type Coverage = { [key: string]: CoverageValue }

const main = () => {
  try {
    // NOTE:(yota-hada) ä»Šå›ã¯ã“ã®scriptã‚’scripts/check-coverage/index.tsã«ãŠã„ãŸã®ã§ã€rootç›´ä¸‹ã‹ã‚‰coverage/coverage-summary.jsonã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ä½™åˆ†ãªpathã‚’æ¶ˆã—ã¦ã‚‹
    const dirNames = __dirname.split('/')
    const filterNames = dirNames.filter(
      (dirName) => dirName !== 'scripts' && dirName !== 'check-coverage',
    )
    const dir = filterNames.join('/')

    const input = JSON.parse(
      readFileSync(`${dir}/coverage/coverage-summary.json`, 'utf-8'),
    ) as Coverage

    const functionCoverage = input.total.functions.pct
    // ã—ãã„å€¤ã£ã¦ã©ã‚Œãã‚‰ã„ãŒè‰¯ã„ã‚“ã§ã—ã‚‡ã­
    const mustCoverage = 80

    if (functionCoverage < mustCoverage) {
      // HACK:(yota-hada) åˆ¥é€”ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’circleciã®artifactsãªã©ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãŠãã€è©³ç´°ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã—ã¨ãã¨ã‚‚ã£ã¨è‰¯ã
      const errMsg = 'ãƒ†ã‚¹ãƒˆã®ã‚«ãƒãƒ¬ãƒƒã‚¸(Functions)ãŒä½ã™ãã¾ã™ã€‚ä»Šã™ããƒ†ã‚¹ãƒˆã‚’æ›¸ãã®ã§ã™'
      throw new Error(errMsg)
    }
  } catch (e) {
    console.error(e)
    process.exit(1)
  }
}

main()
```

## CIã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹
ciã§å‘¼ã³ã‚„ã™ã„ã‚ˆã†ã«scriptsã«ä½¿ã†ã‚‚ã®ã¯ç™»éŒ²ã—ã¨ãã¾ã™

```json:package.json
{
  "scripts": {
    "test-total-coverage": "jest --collectCoverage=true --coverageReporters=json-summary",
    "check-coverage": "ts-node --project scripts/tsconfig.json scripts/check-coverage/main.ts",
  }
}
```

â€»ts-nodeã‚’å®Ÿè¡Œã™ã‚‹æ™‚ã¯scriptç”¨ã®tsconfigã‚’æŒ‡å®šã—ã¦ã¾ã™


ã‚ã¨ã¯å®šç¾©ã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‘¼ã‚“ã§ã‚ã’ã‚‹(ä¸‹è¨˜ã¯circleciã®å ´åˆ)
ã“ã‚Œã§**ç°¡å˜ãª**ã‚«ãƒãƒ¬ãƒƒã‚¸ã®ã—ãã„å€¤ãƒã‚§ãƒƒã‚¯ãŒCIä¸Šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã‚„ã™
```yaml: config.yml
      - run:
          name: Report total coverage
          command: yarn test-total-coverage
      - run:
          name: Check total coverage
          command: yarn check-coverage
```

## å®£ä¼

`Jesté€†å¼•ã ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹`ã£ã¦ã‚¿ã‚¤ãƒˆãƒ«ã§ã‚¹ã‚¯ãƒ©ãƒƒãƒ—ã‚’ä½œã£ã¦ãŠã‚Šã€ä»–ã®æ–¹ã®æŠ•ç¨¿ã‚‚è¨±å¯ã—ã¦ã‚‹ã®ã§ã€ã‚³ãƒ¡ãƒ³ãƒˆã§ã‚‚æ–°ã—ã„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹(Jestå˜ä½“ã®ã§ã‚‚ã€Testing Libraryã‚’ä½¿ã£ãŸã®ã§ã‚‚ã€ãªã‚“ã§ã‚‚)ã§ã‚‚æ›¸ã„ã¦ã‚‚ã‚‰ãˆã‚‹ã¨ã†ã‚Œã—ã„ãƒ‡ã‚¹!

https://zenn.dev/nus3/scraps/f1ea3cb4982593