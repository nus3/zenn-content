---
title: "ã¼ãã®ã‹ã‚“ãŒãˆãŸNext.jsã®æ§‹æˆ"
emoji: "ğŸŒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs", "typescript"]
published: true
---

## ã¯ã˜ã‚ã«

æ™®æ®µé–‹ç™ºã—ã¦ã„ã‚‹ Next.js ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹æˆãŒãªã‹ãªã‹ã„ã‘ã¦ã‚‹ã‚“ã˜ã‚ƒãªã„ã‹ã¨ã„ã†ã“ã¨ã§ã€ãã®æ§‹æˆã‚’å…¬é–‹ã—ã¡ã‚ƒãŠã†ã¨ã„ã†ãŠè©±ã€‚ã»ã‚“ã¨ã¯ã‚¿ã‚¤ãƒˆãƒ«ã‚’`ã¼ããŒã‹ã‚“ãŒãˆãŸã•ã„ãã‚‡ã†ã®Next.jsã®æ§‹æˆ`ã«ã—ãŸã‹ã£ãŸã‘ã©ã²ã‚ˆã‚Šã¾ã—ãŸ

:::message alert
2021/3/25 æ™‚ç‚¹ã®ãƒ¢ãƒã§ã™ã€‚package ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç­‰ã«ã‚ˆã‚Šã“ã“ã§è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹æ–¹æ³•ãŒé–“é•ã£ã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
:::

(ä»Šå›ã®è¨˜äº‹ã‚’ä½œã‚‹ã«ã‚ãŸã‚Šæ”¹ã‚ã¦ä¸€ã‹ã‚‰ Next.js ã®ãƒªãƒã‚¸ãƒˆãƒªä½œã£ãŸã‚‰ husky ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸ŠãŒã£ã¦ãŸã‚Šã€[eslint-config-prettier ã® v8 ç³»ã«ãªã£ã¦ config ã®æ›¸ãæ–¹ã¡ã‚‡ã£ã¨å¤‰ã‚ã£ã¦ãŸã‚Š](https://github.com/prettier/eslint-config-prettier/blob/main/CHANGELOG.md#version-800-2021-02-21)ã€æ™‚ä»£ã¯ç§»ã‚Šå¤‰ã‚ã‚‹ã®ã§ã™ãƒ»ãƒ»)

æ„å¤–ã¨æ‰‹é †æ›¸ã„ã¦ã„ãã¨é•·ããªã£ãŸã®ã§ä¸€éƒ¨`coming soon`ã«ãªã£ã¦ã„ã‚‹ã‚‚ã®ã¯ç¢ºå›ºãŸã‚‹æ„æ€ã‚’æŒã£ã¦ã€éšæ™‚è¿½è¨˜ã—ã¾ã™

## æ›´æ–°å±¥æ­´

- 2021/03/31 ãªã‚“ã¨ç¶šç·¨ãŒå‡ºã¾ã—ãŸ
- 2021/03/26 snapshot ã®æ–¹æ³•è¿½è¨˜
- 2021/03/26 ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®æ–¹æ³•è¿½è¨˜

https://zenn.dev/kichion/articles/fddf0eb35ffa2a

## è¨˜äº‹ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ

- Next.js ã®æ§‹æˆãŒæ°—ã«ãªã‚‹äºº
- è‡ªåˆ†ç”¨ã®æ‰‹é †æ›¸ãƒ¡ãƒ¢ã§ã‚‚ã‚ã‚‹

## æ§‹æˆ

()ã«ä½¿ã£ã¦ã‚‹ç†ç”±ã¨ã‹ç”¨é€”ã¨ã‹æ›¸ã„ã¦ã¾ã™

- Next.js
- TypeScript (ã„ã‚ãšã‚‚ãŒãª)
- Storybook (ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé§†å‹•ã§é–‹ç™ºã§ãã‚‹ã‹ã‚‰)
- ESLint (ã„ã‚ãšã‚‚ãŒãª)
- Prettier (ã„ã‚ãšã‚‚ãŒãª)
- Husky (push ã‚„ commit æ™‚ã« lint ã‚„ format ã‚„ test ã®ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã§ãã‚‹)
- lint-staged (git ã® stage ã«å…¥ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦ lint ã‚„ format ãŒã§ãã‚‹)
- Jest (Unit ãƒ†ã‚¹ãƒˆ + Snapshot)
- Tailwind CSS(è³›å¦ä¸¡è«–ã‚ã‚‹ã‹ã‚‚ã§ã™ãŒå€‹äººçš„ã«æ›¸ã„ã¦ã¦æ¥½ã—ã„ã®ã§æ¡ç”¨)
- [scaffold ã‚³ãƒãƒ³ãƒ‰(ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®è‡ªå‹•ç”Ÿæˆ)ã®è¿½åŠ ](https://zenn.dev/nus3/articles/185c691da82362e0aaa9)
- Renovate(ä¾å­˜ package ã®å®šæœŸçš„ãªæ›´æ–°) **coming soon**[^1]
- storycap + reg-suit(ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ)
- [Cypress (E2E ãƒ†ã‚¹ãƒˆ)](https://zenn.dev/nus3/articles/d8e3221f6bf8ef2382dd)

[^1]: ãã®ã†ã¡è¿½è¨˜ã—ã¾ã™ãƒ»ãƒ»ç¢ºå›ºãŸã‚‹æ„æ€ã‚’æŒã£ã¦ãƒ»ãƒ»

## ç’°å¢ƒ

```json: package.json
  "dependencies": {
    "next": "10.0.9",
    "react": "17.0.2",
    "react-dom": "17.0.2"
  },
  "devDependencies": {
    "@storybook/addon-essentials": "6.2.0-alpha.23",
    "@storybook/addon-links": "6.2.0-alpha.23",
    "@storybook/addon-postcss": "2.0.0",
    "@storybook/addon-storyshots": "6.1.21",
    "@storybook/react": "6.2.0-alpha.23",
    "@testing-library/react": "11.2.5",
    "@types/jest": "26.0.21",
    "@types/node": "14.14.35",
    "@types/react": "17.0.3",
    "@types/react-dom": "17.0.3",
    "@typescript-eslint/eslint-plugin": "4.19.0",
    "@typescript-eslint/parser": "4.19.0",
    "autoprefixer": "10.2.5",
    "babel-jest": "26.6.3",
    "eslint": "7.22.0",
    "eslint-config-prettier": "8.1.0",
    "eslint-plugin-import": "2.22.1",
    "eslint-plugin-react": "7.23.1",
    "eslint-plugin-simple-import-sort": "7.0.0",
    "husky": "5.2.0",
    "jest": "26.6.3",
    "jest-watch-typeahead": "0.6.1",
    "lint-staged": "10.5.4",
    "postcss": "8.2.8",
    "postcss-nested": "5.0.5",
    "prettier": "2.2.1",
    "reg-keygen-git-hash-plugin": "0.10.15",
    "reg-notify-github-plugin": "0.10.15",
    "reg-notify-slack-plugin": "0.10.15",
    "reg-publish-s3-plugin": "0.10.15",
    "reg-suit": "0.10.15",
    "storycap": "3.0.3",
    "tailwindcss": "2.0.4",
    "typescript": "4.2.3"
  }
```

## å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰

https://github.com/yota-hada/next-boilerplate

## Let's try!

1. `npx create-next-app {project-name}`
2. `yarn policies set-version` (yarn ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®š)
3. ç”Ÿæˆã•ã‚ŒãŸ.yarnrc ã«`save-prefix ""`ã®è¿½åŠ (ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ package ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å›ºå®šã™ã‚‹)
4. `.node-version`ã®è¿½åŠ 
5. `mkdir src && mv pages src && mv styles src`(`src`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«è«¸ã€…ã‚’ç§»å‹•ã™ã‚‹)
6. `yarn add --dev typescript @types/react @types/react-dom @types/node` typescript å‘¨ã‚Šã‚’å…¥ã‚Œã‚‹
7. src é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ tsx ã«å¤‰æ›´ã™ã‚‹ + `.babelrc` + `tsconfig.json`
8. `eslint` + `prettier` ã‚’å…¥ã‚Œã‚‹
9. `jest`ã‚’å…¥ã‚Œã‚‹
10. `lint-staged` + `husky`ã‚’å…¥ã‚Œã‚‹
11. `Tailwind CSS`ã‚’å…¥ã‚Œã‚‹
12. `Storybook`ã‚’å…¥ã‚Œã‚‹
13. `storyshots`ã‚’å…¥ã‚Œã¦ snapshot ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹
14. `storycap` + `reg-suit`ã‚’å…¥ã‚Œã¦ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹

### 7.src é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ tsx ã«å¤‰æ›´ã™ã‚‹ + `.babelrc` + `tsconfig.json`

:::details .babelrc

```json: .babelrc
{
  "presets": ["next/babel"]
}
```

:::

:::details tsconfig.json

```json:tsconfig.json
{
  "compilerOptions": {
    "baseUrl": "src",
    "target": "es5",
    "module": "esnext",
    "jsx": "preserve",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "noEmit": true,
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true
  },
  "exclude": ["node_modules", "deployments", ".next", "out"],
  "include": [
    "next-env.d.ts",
    "globals.d.ts",
    "src/**/*.ts",
    "src/**/*.tsx",
    "src/**/*.js",
    "test/**/*.ts",
    "test/**/*.tsx"
  ]
}
```

:::

:::details `_app.tsx`

```tsx: src/pages/_app.tsx
import 'styles/globals.css'

import { NextPage } from 'next'
import { AppProps } from 'next/dist/next-server/lib/router/router'

const MyApp: NextPage<AppProps> = ({ Component, pageProps }: AppProps) => {
  return <Component {...pageProps} />
}

export default MyApp
```

:::

:::details `index.tsx`

```tsx: src/pages/_app.tsx
import { NextPage } from 'next'
import Head from 'next/head'
import styles from 'styles/Home.module.css'

const Home: NextPage = () => {
  return (
    <div className={styles.container}>
      {/* ... */}
    </div>
  )
}

export default Home
```

:::

js ã‹ã‚‰ tsx ã«æ›¸ãç›´ã—ã¦ã‚‹æœ€ä¸­ã«ä¸‹è¨˜éƒ¨åˆ†ã§å‹ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã‹ã‚‚ã§ã™ãŒ
`import styles from 'styles/Home.module.css'`

`yarn dev`ã¨ã‹ã™ã‚‹ã¨`next-env.d.ts`ãŒç”Ÿæˆã•ã‚Œã¦ã‚¨ãƒ©ãƒ¼è§£æ¶ˆã•ã‚Œã‚‹

### 8. eslint + prettier ã‚’å…¥ã‚Œã‚‹

eslint å‘¨ã‚Šã§å¿…è¦ãªã‚‚ã® + è¿½åŠ ã—ãŸã„ eslint rule + prettier ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
yarn add --dev @typescript-eslint/eslint-plugin @typescript-eslint/parser eslint eslint-config-prettier eslint-plugin-react eslint-plugin-import eslint-plugin-simple-import-sort prettier
```

:::details .eslintrc.json

å¥½ã¿ã§ã™
rule ã¯ãã®æ™‚ãã®æ™‚ã§å¿…è¦ãªã‚‚ã®ã‚’å…¥ã‚Œã¾ã—ã‚‡ã†

```json: .eslintrc.json
{
  "parser": "@typescript-eslint/parser",
  "plugins": ["@typescript-eslint", "simple-import-sort", "import"],
  "extends": [
    "eslint:recommended",
    "plugin:react/recommended",
    "plugin:@typescript-eslint/recommended",
    "prettier"
  ],
  "env": {
    "es6": true,
    "browser": true,
    "jest": true,
    "node": true
  },
  "rules": {
    "react/react-in-jsx-scope": 0,
    "react/display-name": 0,
    "react/prop-types": 0,
    "@typescript-eslint/explicit-function-return-type": 0,
    "@typescript-eslint/explicit-member-accessibility": 0,
    "@typescript-eslint/indent": 0,
    "@typescript-eslint/member-delimiter-style": 0,
    "@typescript-eslint/no-explicit-any": 0,
    "@typescript-eslint/no-var-requires": 0,
    "@typescript-eslint/no-use-before-define": 0,
    "@typescript-eslint/no-unused-vars": [
      2,
      {
        "argsIgnorePattern": "^_"
      }
    ],
    "no-console": [
      2,
      {
        "allow": ["warn", "error"]
      }
    ],
    "simple-import-sort/imports": "error",
    "simple-import-sort/exports": "error",
    "import/no-unresolved": "off",
    "sort-imports": "off",
    "react/self-closing-comp": [
      "error",
      {
        "component": true,
        "html": true
      }
    ]
  }
}

```

:::

:::details .prettierrc

å¥½ã¿ã§ã™

```json: .prettierrc
{
  "singleQuote": true,
  "semi": false,
  "trailingComma": "all"
}
```

:::

vscode ä½¿ã£ã¦ãŸã‚‰ vscode ã®è¨­å®šå…¥ã‚Œã‚‹

:::details .vscode/settings.json

```json: .vscode/settings.json
{
  "editor.tabSize": 2,
  "editor.codeActionsOnSave": {
    "source.fixAll": true
  },
  "css.validate": false
}
```

:::

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å¿…è¦ãª vscode ã®æ‹¡å¼µã‚‚ã‚ã‚Œã°ç”¨æ„ã—ã¨ãã¨æ·±åˆ‡
:::details .vscode/extensions.json

```json: .vscode/extensions.json
{
  "recommendations": [
    "dbaeumer.vscode-eslint",
    "esbenp.prettier-vscode",
  ]
}
```

:::

### 9. `jest`ã‚’å…¥ã‚Œã‚‹

```bash
yarn add --dev @testing-library/react @types/jest babel-jest jest jest-watch-typeahead
```

:::details jest.config.js

```js: jest.config.js
module.exports = {
  roots: ['<rootDir>'],
  moduleFileExtensions: ['ts', 'tsx', 'js', 'json', 'jsx'],
  testPathIgnorePatterns: [
    '<rootDir>[/\\\\](node_modules|.next)[/\\\\]',
    '<rootDir>/test/Storyshots.test.ts',
  ],
  transformIgnorePatterns: ['[/\\\\]node_modules[/\\\\].+\\.(ts|tsx)$'],
  transform: {
    '^.+\\.(js|ts|tsx)$': 'babel-jest',
  },
  watchPlugins: [
    'jest-watch-typeahead/filename',
    'jest-watch-typeahead/testname',
  ],
  moduleNameMapper: {
    '\\.(styl|css|less|scss)$': '<rootDir>/test/__mocks__/styleMock.js',
    '\\.(gif|ttf|eot|svg|png)$': '<rootDir>/test/__mocks__/fileMock.js',
  },
  moduleDirectories: ['node_modules', 'src'],
}
```

:::

:::details snapshot ãƒ†ã‚¹ãƒˆã§ mock å¯¾å¿œã™ã‚‹ã®ã§å…ˆã«è¨­å®šã—ã¨ã

`jest.config.js`ã®`moduleNameMapper`ã®ã¨ã“ã‚

```js:test/__mocks__/fileMock.js
module.exports = 'test-file-stub'
```

```js:test/__mocks__/styleMock.js
module.exports = {}
```

:::

:::details package.json ã®ã‚³ãƒãƒ³ãƒ‰è¿½åŠ 

linter ã¨ formatter ã®ã‚³ãƒãƒ³ãƒ‰ã‚‚è¿½åŠ ã™ã‚‹ã®å¿˜ã‚ŒãŸã®ã§ã“ã“ã§è¨˜è¼‰ã™ã‚‹

```json:package.json
  "scripts": {
    "type-check": "tsc --pretty --noEmit",
    "format": "prettier --write .",
    "lint": "eslint src --ext ts --ext tsx",
    "test": "jest",
    "test-all": "yarn lint && yarn type-check && yarn test"
  },
```

:::

:::details ã‚µãƒ³ãƒ—ãƒ«ã®ãƒ†ã‚¹ãƒˆã§å‹•ä½œç¢ºèªã™ã‚‹

```tsx:test/pages/index.test.tsx
import '@jest/globals'

describe('jest å‹•ä½œç¢ºèª', () => {
  test('true toBeTruthy', () => {
    expect(true).toBeTruthy()
  })
})
```

`yarn test`ã§ jest å®Ÿè¡Œã•ã‚Œã‚‹ã‹ã©ã†ã‹ç¢ºèªã™ã‚‹

:::

### 10. `lint-staged` + `husky`ã‚’å…¥ã‚Œã‚‹

stage ã«ä¸ŠãŒã£ã¦ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦ lint ã‹ã‘ã¦ãã‚Œã‚‹`lint-staged`ã¨ git ã®ã‚³ãƒŸãƒƒãƒˆã‚„ãƒ—ãƒƒã‚·ãƒ¥å‰ã®ã¨ãã«ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã‚Œã‚‹`husky`ã‚’å…¥ã‚Œã‚‹

```bash
yarn add --dev husky lint-staged
```

:::details lint-staged ã®è¨­å®šã‚’ package.json ã«è¿½åŠ 

```json:package.json
  "lint-staged": {
    "*.@(ts|tsx)": [
      "yarn lint",
      "yarn format"
    ]
  },
```

:::

:::details husky ã®è¨­å®šè¿½åŠ 

`yarn husky install`

ä»Šå›ã¯ pre-commit ã¨ pre-push ã®è¨­å®šã ã‘ã—ã¨ã

- ã‚³ãƒŸãƒƒãƒˆå‰ã« stage ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦ lint ã¨ format ã‚’å®Ÿè¡Œã™ã‚‹
- push å‰ã« test ã¨ å‹ãƒã‚§ãƒƒã‚¯ ã‚’å®Ÿè¡Œã™ã‚‹

```shell:.husky/pre-commit
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

yarn lint-staged
```

```shell:.husky/pre-push
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

yarn test & yarn type-check
```

:::

### 11. `Tailwind CSS`ã‚’å…¥ã‚Œã‚‹

[å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://tailwindcss.com/docs/guides/nextjs#install-tailwind-via-npm)é€šã‚Šã«é€²ã‚ã‚Œã°ã„ã‘ã‚‹

1. `yarn add --dev tailwindcss postcss autoprefixer postcss-nested`
2. `yarn tailwindcss init -p`

tailwindcss ã‚’èª­ã¿è¾¼ã‚€

:::details globals.css

```css:src/styles/globals.css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

vscode ã® setting.json ã§`"css.validate": false`ã™ã‚‹ã“ã¨ã§`@tailwind`ã®ã‚¨ãƒ©ãƒ¼ã‚’æ¶ˆã™(æ­£ã—ã„ã‹ã©ã†ã‹ã¯å®šã‹ã§ã¯ãªã„)
:::

:::details tailwind.config.js

**å¾Œã€…ã€js ã§å‹•çš„ãª class åã‚’ç”Ÿæˆã™ã‚‹å ´åˆ(ä¸‹è¨˜ã® classnames)ã¯ safelist ã®è¨­å®šã‚’ã—ã¨ã**
purge ã®è¨­å®šã¦ä¸‹è¨˜ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã¯ tailwindcss å´ã§èª­ã¿è¾¼ã¾ã‚Œãªã„æ„Ÿã˜ãªã®ã§ safelist ã§ purge ã—ãªã„ã§ã£ã¦è¨­å®šã‚’ã™ã‚‹
https://tailwindcss.com/docs/optimizing-for-production#writing-purgeable-html

```tsx
const spanClass = classnames(`text-${fontSize}`, `text-${color}`);
```

```js:tailwind.config.js
module.exports = {
  purge: {
    content: ['./src/components/**/*.tsx', './src/pages/**/*.tsx'],
    options: {
      // https://purgecss.com/safelisting.html#patterns
      safelist: {
        standard: [/^bg-/, /^text-/],
      },
    },
  },
  darkMode: false, // or 'media' or 'class'
  theme: {
    extend: {},
  },
  variants: {
    extend: {},
  },
  plugins: [],
}
```

:::

:::details postcss.config.js
å¥½ã¿
sass ã¿ãŸã„ã«ãƒã‚¹ãƒˆã—ãŸæ›¸ãæ–¹ãŒã§ãã‚‹`postcss-nested`ã‚’è¿½åŠ 

```diff js:postcss.config.js
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
+    'postcss-nested': {},
  },
}

```

:::

`src/pages/index.tsx`ã¨ã‹ã§é©å½“ãªè¦ç´ ã®`className`ã‚’å¤‰ãˆã¦ã¿ã¦ã€ã¡ã‚ƒã‚“ã¨ tailwindcss ãŒä½¿ãˆã‚‹ã‹ç¢ºèªã™ã‚‹

```diff tsx:src/pages/index.tsx
- <h1 className={styles.title}>
-   Welcome to <a href="https://nextjs.org">Next.js!</a>
- </h1>
+ <h1 className="text-bg-500">
+   Welcome to <a href="https://nextjs.org">Next.js!</a>
+ </h1>
```

:::details .vscode/extensions.json
tailwindcss ã®æ‹¡å¼µãŒä¾¿åˆ©ãªã®ã§å…¥ã‚Œã‚‹

```diff json: .vscode/extensions.json
{
  "recommendations": [
    "dbaeumer.vscode-eslint",
    "esbenp.prettier-vscode",
+    "bradlc.vscode-tailwindcss",
  ]
}
```

:::

### 12. `Storybook`ã‚’å…¥ã‚Œã‚‹

> Error: PostCSS plugin tailwindcss requires PostCSS 8.

tailwindcss(v2)ã‚’ä½¿ã†å ´åˆ postcss ã¯ v8 ãŒå¿…è¦ã ãŒ storybook ã® 6.1 ç³»ã§ã¯ postcss ãŒ v7 ç³»ãªã®ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã®ã§`6.2.0-alpha.23` + `@storybook/addon-postcss`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã‚‹

[å‚è€ƒã«ã—ãŸ issue](https://github.com/storybookjs/storybook/issues/12668#issuecomment-773958085)

`yarn add -D @storybook/react@6.2.0-alpha.23 @storybook/addon-links@6.2.0-alpha.23 @storybook/addon-essentials@6.2.0-alpha.23 @storybook/addon-postcss`

`.storybook`é…ä¸‹ã«å¿…è¦ãªè¨­å®šã‚’å…¥ã‚Œã‚‹

:::details .storybook ã®è¨­å®š

- addon-postcss å…¥ã‚Œã‚‹ã“ã¨ã§ postcss8 å¯¾å¿œ
- tsconfig ã® baseUrl ã®å¯¾å¿œã™ã‚‹ãŸã‚ã« webpack.config ã‚’ä¸Šæ›¸ã

```js: .storybook/main.js
const path = require('path')

module.exports = {
  stories: [
    '../src/components/**/**/*.stories.mdx',
    '../src/components/**/**/*.stories.@(js|jsx|ts|tsx)',
  ],
  addons: [
    '@storybook/addon-essentials',
    '@storybook/addon-links',
    {
      name: '@storybook/addon-postcss',
      options: {
        postcssLoaderOptions: {
          implementation: require('postcss'),
        },
      },
    },
  ],
  webpackFinal: async (baseConfig) => {
    // NOTE: tsconfigã®baseUrlã®å¯¾å¿œ
    baseConfig.resolve.modules = [
      path.resolve(__dirname, '..', 'src'),
      'node_modules',
    ]
    return { ...baseConfig }
  },
}
```

Next.js ã® router ã‚’ storybook ã«è¼‰ã›ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ä½¿ã†å ´åˆã® mock

```js: .storybook/newRouterMock.js
import * as nextRouter from 'next/router'

nextRouter.useRouter = () => ({
  route: '/',
  pathname: '/',
  push: () => {},
  prefetch: () => new Promise((resolve, reject) => {}),
})

```

postcss ã® config ã‚’ root ç›´ä¸‹ã‹ã‚‰å–å¾—

```js: .storybook/postcss.config.js
const postcssConfig = require('../postcss.config')
const usePlugins = {}

// NOTE: Using Next.js postcss config
// Convert a plugins format for postcss-loader.
postcssConfig.plugins.forEach((plugin) => {
  // Has options?
  if (Array.isArray(plugin) && plugin.length === 2) {
    usePlugins[plugin[0]] = plugin[1]
  } else {
    usePlugins[plugin] = {}
  }
})

module.exports = {
  plugins: usePlugins,
}

```

tailwindcss ã®èª­ã¿è¾¼ã¿ã‚„ addon ã®è¨­å®š(addon ã®è¨­å®šã¯å¥½ã¿ã§ã™)

```js: .storybook/preview.js
import style from '../src/styles/globals.css'
import router from './newRouterMock'

export const parameters = {
  actions: { argTypesRegex: '^on[A-Z].*' },
  layout: 'fullscreen',
  backgrounds: {
    default: 'light',
    values: [
      { name: 'light', value: '#F7F8FA' },
      { name: 'dark', value: '#314565' },
      { name: 'white', value: '#FFFFFF' },
      { name: 'black', value: '#000000' },
    ],
  },
}
```

:::

:::details package.json ã«ã‚³ãƒãƒ³ãƒ‰è¿½åŠ 

```diff json:package.json
  "scripts": {
+    "storybook": "start-storybook -p 9009 -s ./public",
+    "build-storybook": "build-storybook -s ./public"
  },
```

:::

### 13. `storyshots`ã‚’å…¥ã‚Œã¦ snapshot ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹

1. storybook ã® snapshot ç”¨ã® addon ã‚’å…¥ã‚Œã‚‹ `yarn add -D @storybook/addon-storyshots`
2. snapshot ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹
3. jest ã® config ã‚’ä¿®æ­£
4. package.json ã«ã‚³ãƒãƒ³ãƒ‰è¿½åŠ 
5. snapshot ãƒ†ã‚¹ãƒˆãŒå‹•ãã‹ç¢ºèªã™ã‚‹

:::details snapshot ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹

[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®é€šã‚Š](https://storybook.js.org/docs/react/workflows/snapshot-testing)

```typescript: test/test.storyshots.ts
import initStoryshots, {
  multiSnapshotWithOptions,
} from '@storybook/addon-storyshots'

initStoryshots({
  integrityOptions: { cwd: __dirname },
  test: multiSnapshotWithOptions(),
})

```

:::

:::details jest ã® config ã‚’ä¿®æ­£

unit ãƒ†ã‚¹ãƒˆæ™‚ã® config ã¨ snapshot ã® config ã‚’åˆ†ã‘ã‚‹
ä½•ã‚’åˆ†ã‘ãŸã‹ã¨ã„ã†ã¨`testMatch`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§å®Ÿè¡Œã™ã‚‹ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†ã‘ãŸæ„Ÿã˜

unit ãƒ†ã‚¹ãƒˆç”¨ã® config

```javascript: jest.config.js
module.exports = {
  roots: ['<rootDir>'],
  moduleFileExtensions: ['ts', 'tsx', 'js', 'json', 'jsx'],
  testPathIgnorePatterns: ['<rootDir>[/\\\\](node_modules|.next)[/\\\\]'],
  transformIgnorePatterns: ['[/\\\\]node_modules[/\\\\].+\\.(ts|tsx)$'],
  transform: {
    '^.+\\.stories\\.tsx$': '@storybook/addon-storyshots/injectFileName',
    '^.+\\.(js|ts|tsx)$': 'babel-jest',
  },
  testMatch: ['<rootDir>/**/?(*.)(spec|test).(ts|js)?(x)'],
  watchPlugins: [
    'jest-watch-typeahead/filename',
    'jest-watch-typeahead/testname',
  ],
  moduleNameMapper: {
    '\\.(styl|css|less|scss)$': '<rootDir>/test/__mocks__/styleMock.js',
    '\\.(gif|ttf|eot|svg|png)$': '<rootDir>/test/__mocks__/fileMock.js',
  },
  moduleDirectories: ['node_modules', 'src'],
}
```

snapshot ã® config

```javascript: jest.storyshots.config.js
const baseConfig = require('./jest.config')

module.exports = {
  ...baseConfig,
  name: 'Storyshots',
  displayName: 'storyshots',
  testMatch: ['<rootDir>/test/test.storyshots.ts'],
  moduleNameMapper: {
    ...baseConfig.moduleNameMapper,
  },
}
```

:::

:::details package.json ã«ã‚³ãƒãƒ³ãƒ‰è¿½åŠ 

```diff json:package.json
  "scripts": {
    "test": "jest",
    "test-all": "yarn lint && yarn type-check && yarn test",
+   "storyshots": "NODE_ENV=test jest --config ./jest.storyshots.config.js",
+   "update-storyshots": "NODE_ENV=test jest --config ./jest.storyshots.config.js --updateSnapshot",
  },
```

:::

`yarn storyshots`ã§å‰å›ã® snapshot ã¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å†…å®¹ãŒå¤‰ã‚ã£ã¦ãªã„ã‹ãƒ†ã‚¹ãƒˆã—ã€
`yarn update-storyshots`ã§ snapshot ã‚’æ›´æ–°ã™ã‚‹

### 14. `storycap` + `reg-suit`ã‚’å…¥ã‚Œã¦ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹

ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚’å°å…¥ã™ã‚‹ã“ã¨ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è¦‹ãŸç›®ãŒæ„å›³ã—ãªã„å¤‰æ›´ã‚’ã—ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯ã§ãã‚‹(ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã¨ã‹ã§)
ä»•çµ„ã¿ã¨ã—ã¦ã¯ storycap ã§ storybook ã«ç™»éŒ²ã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚¹ã‚¯ã‚·ãƒ§ã‚’ã¨ã‚Šã€reg-suit ã§å‰å›ã®ã‚¹ã‚¯ã‚·ãƒ§ã¨æ¯”è¼ƒã—ã¦è¦‹ãŸç›®ãŒå¤‰ã‚ã£ã¦ã„ãªã„ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã‚Œã‚‹

1. storycap ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« `yarn add --dev storycap`
2. package ã« screenshot ã‚³ãƒãƒ³ãƒ‰ã‚’è¿½åŠ 
3. screenshot ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹
4. reg-suit ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
5. [reg-suit ã® github app ã‚’å…¥ã‚Œã‚‹](https://github.com/apps/reg-suit)
6. slack ã® webhook ã®ç”¨æ„
7. aws cli ã§ s3 ã®ãƒã‚±ãƒƒãƒˆã®ä½œæˆãŒã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠã
8. `reg-suit init`ã§åˆæœŸè¨­å®š
9. `reg-suit run`ã§ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹

---

:::details package ã« screenshot ã‚³ãƒãƒ³ãƒ‰ã‚’è¿½åŠ 

```diff json:package.json
  "scripts": {
    "storybook": "start-storybook -p 9009 -s ./public",
    "build-storybook": "build-storybook -s ./public",
+   "screenshot": "storycap http://localhost:9009 --serverCmd 'start-storybook -p 9009 -s ./public'"
  },
```

:::

`yarn screenshot`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ root ç›´ä¸‹ã«`__screenshots__`ãŒä½œæˆã•ã‚Œ storybook ã®ã‚¹ã‚¯ã‚·ãƒ§ãŒä¿å­˜ã•ã‚Œã‚‹

---

#### reg-suit ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

`yarn add --dev reg-suit`

#### reg-suit ã® github app ã‚’å…¥ã‚Œã¦ã€`Repository access`ã‹ã‚‰ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ãŸã„ãƒªãƒã‚¸ãƒˆãƒªã‚’é¸æŠã™ã‚‹

![](https://storage.googleapis.com/zenn-user-upload/82sv8dl58jjcehccv8wk3hyh7hq3)

`You can get client IDs here.`ã® here ã‹ã‚‰ client id ã‚’ãƒ¡ãƒ¢ã‚‹
![](https://storage.googleapis.com/zenn-user-upload/h2pg0vouljwa4ae0ootnwukp7ebq)

#### `reg-suit init`ã§åˆæœŸè¨­å®š

ä»Šå›ã¯ github ã§ä½œæˆã—ãŸãƒ—ãƒ«ãƒªã‚¯ã®ã‚³ãƒ¡ãƒ³ãƒˆã«ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®çµæœã‚’è¿½åŠ ã—ã¦ã»ã—ã„ã®ã¨ã‚¹ã‚¯ã‚·ãƒ§ã‚’ S3 ã«ä¿å­˜ã€Slack é€šçŸ¥ã¯è©¦ã—ã¦ã¿ãŸã‹ã£ãŸã®ã§ä¸‹è¨˜ã® 4 ã¤ã‚’é¸æŠã—ãŸ
![](https://storage.googleapis.com/zenn-user-upload/9n0r8ylorodok8t9skc09pgnk76b)

:::details `reg-suit init` ã§ã®ä¸€å•ä¸€ç­”

```shell
[reg-suit] info version: 0.10.15
? Plugin(s) to install (bold: recommended)  reg-keygen-git-hash-plugin : Detect the snapshot key to be compare with using Git hash.,  re
g-notify-github-plugin : Notify reg-suit result to GitHub repository,  reg-publish-s3-plugin : Fetch and publish snapshot images to AWS
S3.,  reg-notify-slack-plugin : Notify reg-suit result to Slack channel.
[reg-suit] info Install dependencies to the local directory. This procedure takes some minutes, please wait.
? Working directory of reg-suit. .reg
? Append ".reg" entry to your .gitignore file. Yes
? Directory contains actual images. __screenshots__ {ã‚¹ã‚¯ã‚·ãƒ§ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã‚‹ã¨ã“ã‚ã®æŒ‡å®š}
? Threshold, ranges from 0 to 1. Smaller value makes the comparison more sensitive. 0
[reg-suit] info Set up reg-notify-github-plugin:
? notify-github plugin requires a client ID of reg-suit GitHub app. Open installation window in your browser No {github appã®reg suitç®¡ç†ç”»é¢ã‹ã‚‰client-idå–å¾—ã—ã¦ãŸã‚‰Noã§ã‚ˆã—}
? This repositoriy's client ID of reg-suit GitHub app {client idè²¼ã‚Šä»˜ã‘}
[reg-suit] info Set up reg-notify-slack-plugin:
? Incoming webhook URL {slackã®webhook urlè²¼ã‚Šä»˜ã‘}
? Send test message to this URL ? No
[reg-suit] info Set up reg-publish-s3-plugin:
? Create a new S3 bucket Yes {aws cliã§s3ã®ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã§ãã‚‹æ¨©é™ãŒã‚ã‚Œã°ã‚ˆã—ãªã«ãƒã‚±ãƒƒãƒˆã‚’ä½œã£ã¦ãã‚Œã‚‹}
[reg-publish-s3-plugin] info Create new S3 bucket: {ãƒã‚±ãƒƒãƒˆå}
? Update configuration file Yes
? Copy sample images to working dir No

```

yarn ã‚’ä½¿ã£ã¦ã‚‹å ´åˆã¯ init ã™ã‚‹ã¨å¿…è¦ãªä¾å­˜é–¢ä¿‚ãŒ npm ã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã®ã§æ”¹ã‚ã¦ yarn ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ç›´ã™
`yarn add --dev reg-keygen-git-hash-plugin reg-notify-github-plugin reg-publish-s3-plugin reg-notify-slack-plugin`

`__screenshots__`ã¨`.reg`ã¯ gitignore ã—ã¦ãŠã

`reg-suit init`ã‚’å®Ÿè¡Œã™ã‚‹ã¨`regconfig.json`ãŒç”Ÿæˆã•ã‚Œã‚‹
ã¾ãŸ s3 ã«ãƒã‚±ãƒƒãƒˆãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹

ã†ã¾ãã„ã‹ãªã„å ´åˆã¯å¤§æŠµã€aws cli å‘¨ã‚ŠãŒåŸå› 
(s3 ãƒã‚±ãƒƒãƒˆã‚’ä½œã‚‹æ¨©é™ãŒãªã„ aws ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ aws cli ã‚’å®Ÿè¡Œã—ã¦ã‚‹ã¨ã‹)
:::

`__screenshots__`é…ä¸‹ã«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãŒã‚ã‚‹çŠ¶æ…‹ã§`reg-suit run`ã‚’å®Ÿè¡Œã™ã‚‹
ã†ã¾ãã„ã‘ã° s3 ã«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãŒä¿å­˜ã•ã‚Œã€webhook ã‚’æŒ‡å®šã—ãŸ slack ã®ãƒãƒ£ãƒãƒ«ã«ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆçµæœã®é€šçŸ¥ãŒãã‚‹

:::details package ã« ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®ã‚³ãƒãƒ³ãƒ‰ã‚’è¿½åŠ 

```diff json:package.json
  "scripts": {
+    "visual-test": "reg-suit run --quiet"
  },
```

:::

ä»Šå›ã¯ public ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã—ã¦ã„ã‚‹é–¢ä¿‚ä¸Šã€`regconfig.json`ã« client-id ã‚„ slack ã® webhook ã‚’è¨˜è¼‰ã—ã¦ã„ãªã„ã®ã§ github ã®ãƒ—ãƒ«ãƒªã‚¯ã‚’ä½œæˆã—ãŸéš›ã«`reg-suit run`ã®ãƒ¬ãƒãƒ¼ãƒˆãŒã‚³ãƒ¡ãƒ³ãƒˆã•ã‚Œã‚‹ã‹ã‚’æ¤œè¨¼ã—ã¦ã„ãªã„ã€‚
ãŸã ã€æ­£ã—ã client-id ã®è¨­å®šã¨ã€github app ã‚’ç™»éŒ²ã—ãŸä¸Šã§ã€CI(circleci ãªã©) ã§`reg-suit run --quiet`ã™ã‚‹ã¨æ·»ä»˜ã®ã‚ˆã†ãªãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã‚Œã‚‹

![](https://storage.googleapis.com/zenn-user-upload/is3nncui3t3sj9halwoch3jnqnsc)

:::details å‚è€ƒ: circleci ã® config.yml

circleci ã® context ã« aws ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã¨ã‹ç™»éŒ²ã—ã¦ã‚‹
ä»Šå›ã¯`hotfix|staging|main`ãƒ–ãƒ©ãƒ³ãƒä»¥å¤–ã§ã‚ã‚Œã°ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ãªæ›¸ãæ–¹

```yaml:.circleci/config.yml
orbs:
  aws-cli: circleci/aws-cli@1.4.0
executors:
  with_browsers:
    working_directory: /home/circleci/src/
    docker:
      - image: circleci/node:14.16.0-browsers

jobs:
  visual_regression:
    executor: with_browsers
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: install jp fonts
          command: sudo apt update && sudo apt-get install fonts-ipafont-gothic fonts-ipafont-mincho
      - run:
          name: screenshots
          command: yarn screenshot
      - run:
          name: regression
          command: yarn visual-test

workflows:
  run_all:
    jobs:
      - visual_regression:
          name: visual regression testing for stage
          context: {circleciã®context}
          requires:
            - build
          filters:
            tags:
              ignore: /.*/
            branches:
              ignore: /(hotfix(\/.+)|staging|main)?/

```

:::
