---
title: "React.memoã‚’ä½¿ã£ãŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–å…¥é–€"
emoji: "ğŸ“"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["react"]
published: true
---

## ã¯ã˜ã‚ã«

React ã®ãƒ¡ãƒ¢åŒ–ã‚’ãªã‚“ã¨ãªãä½¿ã†ç¾çŠ¶ã‹ã‚‰å’æ¥­ã—ãŸã‹ã£ãŸã®ã§ã€ä¸‹è¨˜ãƒªãƒ³ã‚¯ã‚’å‚è€ƒã«[^1]`React.memo` `useCallback` `useMemo`ã‚’ãã‚Œãã‚Œå®Ÿè£…ã—ã¦ã¿ãŸã¾ã¨ã‚
https://qiita.com/soarflat/items/b9d3d17b8ab1f5dbfed2

[^1]: è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã‹ã‚‰æ°—ã«ãªã‚‹éƒ¨åˆ†ã‚’æ·±ã¼ã£ã¦å®Ÿè£…ã—ãŸã®ã§ä¼¼ãŸæ§˜ãªã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚ã¨ã¦ã‚‚ã‚ã‹ã‚Šã‚„ã™ã„è¨˜äº‹ã ã£ãŸã®ã§ãã¡ã‚‰ã‚‚ã”å‚è€ƒã«ã€‚

## è¨˜äº‹ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ

- `React.memo` `useCallback` `useMemo`ã‚’ã©ã“ã‹é ã–ã‘ã¦ã„ãŸäºº
- è¦ªã‚„å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒæ°—ã«ãªã‚‹äºº
- `ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®æœ€é©åŒ–`ãŒã‹ã£ã“ã„ã„éŸ¿ãã«è¦‹ãˆã‚‹äºº
- React æ›¸ãå§‹ã‚ãŸäººã«`ãã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¡ã‚ƒã‚“ã¨æœ€é©åŒ–ã—ã¦ã‚‹?`ã¨ã‹ãƒ‰ãƒ¤ã‚ŠãŸã„äºº

## ç’°å¢ƒ

é–¢ä¿‚ã‚ã‚Šãã†ãªã¨ã“ã ã‘

```json:package.json
  "dependencies": {
    "next": "10.0.3",
    "react": "17.0.1",
    "react-dom": "17.0.1",
  },
```

å®Ÿéš›ã«æŒ™å‹•ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«å®Ÿè£…ã—ãŸã‚³ãƒ¼ãƒ‰ã¯ã“ã“ã«
https://github.com/yota-hada/p-next/tree/main/src/pages/memo

## ã©ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã®ã‹

è‡ªåˆ†ã® state ãŒæ›´æ–°ã•ã‚ŒãŸã¨ãã«**è‡ªåˆ†è‡ªèº«+ä½¿ã£ã¦ã„ã‚‹å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**ãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹

```tsx
type ChildProps = {
  count: number;
};

const Child = ({ count }: ChildProps): JSX.Element => {
  useEffect(() => {
    console.log("ChildãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸã‚ˆ");
  });

  return <p>Childï¼š{count}</p>;
};

const Parent: NextPage = () => {
  const [parentCount, setParentCount] = useState<number>(0);
  const [childCount, setChildCount] = useState<number>(0);

  useEffect(() => {
    console.log("ParentãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸã‚ˆ");
  });

  return (
    <div>
      <button
        type="button"
        onClick={() => {
          setParentCount(parentCount + 1);
        }}
      >
        Parent count up
      </button>
      <button
        type="button"
        onClick={() => {
          setChildCount1(childCount1 + 1);
        }}
      >
        Child1 count up
      </button>
      <p>Parentï¼š{parentCount}</p>
      <Child count={childCount} />
    </div>
  );
};
```

ã“ã®å ´åˆ`setParentCount`ã¨`setChildCount`ãŒå‘¼ã°ã‚Œ state ã®å€¤ãŒæ›´æ–°ã•ã‚Œã‚‹ãŸã³ã«`Child`ã‚‚`Parent`ã‚‚å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹
![](https://i.gyazo.com/cd1f1dc841de9bc24b9259646dfe61d8.gif)

ã“ã‚Œãã‚‰ã„ã®è¦ç´ æ•°ãªã‚‰ç‰¹æ®µæ°—ã«ã™ã‚‹å¿…è¦ã‚‚ãªã„ãŒã€ã‚‚ã—ã“ã® Child ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ãŸã³ã«é‡ã„è¨ˆç®—å‡¦ç†ã‚’ã—ã¦ã„ãŸã‚Šã€Child ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãªã‹ã«å¤§é‡ã«è¡¨ç¤ºã•ã‚Œã‚‹è¦ç´ ãŒã‚ã‚‹å ´åˆã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚³ã‚¹ãƒˆãŒé«˜ããªã‚‹
Child ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ¡ãƒ¢åŒ–ã—ã¦ãŠã‘ã° Child ãŒæç”»ã™ã‚‹ã®ã«é–¢ä¿‚ãªã„å€¤ãŒè¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå´ã§å¤‰æ›´ã•ã‚Œã¦ã‚‚ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹

## ãƒ¡ãƒ¢åŒ–ã—ã¦ã¿ã‚‹

`React.memo`ã‚’ä½¿ã†ã¨è¦ªã‹ã‚‰å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«æ¸¡ã—ã¦ã„ã‚‹ props ãŒæ›´æ–°ã•ã‚Œãªã„é™ã‚Š(å¾Œè¿°ã™ã‚‹ callback é–¢æ•°ã¨ã‹ã¯åˆ¥)å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œãªã„

```diff tsx
- import { useEffect, useState } from 'react'
+ import { memo, useEffect, useState } from 'react'

+ const ChildMemo = memo<ChildProps>(({ count }) => <Child count={count} />)

  return (
    <div>
-      <Child count={childCount} />
+      <ChildMemo count={childCount} />
    </div>
  )
```

ã“ã®å ´åˆ`setParentCount`ãŒå‘¼ã°ã‚Œã¦ã‚‚ãƒ¡ãƒ¢åŒ–ã•ã‚ŒãŸ`Child`ã¯å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œãšã«`Parent`ã ã‘å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹(Child ã«æ¸¡ã—ã¦ã„ã‚‹ props ã®å€¤ã¯æ›´æ–°ã•ã‚Œã¦ã„ãªã„ã®ã§)
`setChildCount`ã§`Child`ã® props ã«æ¸¡ã—ã¦ã„ã‚‹å€¤ã‚’æ›´æ–°ã™ã‚‹ã¨`Child`ã‚‚`Parent`ã‚‚å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹
![](https://i.gyazo.com/da066f115f5139a255b6040eec8d0957.gif)

### useMemo ã¨ React.memo ã®é•ã„

React.memo ã® hook ç‰ˆã˜ã‚ƒã­ã¨æ€ã£ãŸã‚‰é•ã£ãŸã£ã¦è©±ã€‚

ã•ã£ãã®ã‚³ãƒ¼ãƒ‰ã‚’ useMemo ã§æ›¸ãæ›ãˆã¦ã¿ã‚‹

```diff tsx
- import { memo, useEffect, useState } from 'react'
+ import { useEffect, useMemo, useState } from 'react'

- const ChildMemo = memo<ChildProps>(({ count }) => <Child count={count} />)

+ const childMemo = useMemo(() => <Child count={childCount} />, [])

  return (
    <div>
-      <ChildMemo count={childCount} />
+      {childMemo}
    </div>
  )
```

`useMemo`ã¯ç¬¬äºŒå¼•æ•°ã«ä¾å­˜é…åˆ—ã‚’æŒ‡å®šã™ã‚‹
ä¾å­˜é…åˆ—ã§æŒ‡å®šã—ãŸå€¤ãŒæ›´æ–°ã•ã‚ŒãŸæ™‚ã«å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹
ä»Šå›ã®æ›¸ãæ–¹ã ã¨ä¾å­˜é…åˆ—ã«ä½•ã‚‚æŒ‡å®šã—ã¦ã„ãªã„ã®ã§`Child`ã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œãªã„
![](https://i.gyazo.com/b457a97cf5a42b5d9ae7672c4d7c5a28.gif)

ä¾å­˜é…åˆ—ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§`childCount`ãŒæ›´æ–°ã•ã‚ŒãŸã‚‰`Child`ãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹æ§˜ã«ãªã‚‹

```diff tsx
- const childMemo = useMemo(() => <Child count={childCount} />, [])
+ const childMemo = useMemo(() => <Child count={childCount} />, [childCount])
```

### React.memo åŒ–ã•ã‚ŒãŸå­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã® props ã« callback é–¢æ•°ã‚’æ¸¡ã—ãŸã¨ãã®æŒ™å‹•

è¦ªã§å®šç¾©ã—ãŸé–¢æ•°ã‚’å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã« props ã¨ã—ã¦æ¸¡ã™ã¨å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ memo åŒ–ã—ã¦ã‚‚å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹

Child ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```diff tsx
type ChildProps = {
  count: number
+  handleClick: () => void
}

- return <p>Childï¼š{count}</p>;

+  return (
+    <>
+      <p>Childï¼š{count}</p>
+      <button
+        type="button"
+        onClick={() => {
+          handleClick()
+        }}
+      >
+        Child Button
+      </button>
+    </>
+  )
```

Parent ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```diff tsx
+  const handleClick = () => {
+    console.log('Childã®ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚ˆ')
+  }

  return (
    <div>
    ã€€{/* ....çœç•¥ */}
-      <ChildMemo count={childCount} />
+      <ChildMemo count={childCount} handleClick={handleClick} />
    </div>
  )
```

è¦ªãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ãŸã³ã«è¦ªã§å®šç¾©ã—ãŸé–¢æ•°ã‚‚å†ç”Ÿæˆã•ã‚Œã‚‹ã®ã§çµæœã¨ã—ã¦ã€å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ memo åŒ–ã—ã¦ã‚‚è¦ªã® state ãŒæ›´æ–°ã•ã‚Œã‚‹ã¨å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚‚å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ã—ã¾ã†
![](https://i.gyazo.com/28d08179ab2f6ab0ec47c7a65dd0812a.gif)

### useCallback

è¦ªãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ãŸã³ã«è¦ªã§å®šç¾©ã—ãŸé–¢æ•°ã‚‚å†ç”Ÿæˆã•ã‚Œãªã„ã‚ˆã†ã«`useCallback`ã§é–¢æ•°ã‚’ãƒ¡ãƒ¢åŒ–ã™ã‚‹
useCallback ã¯ useMemo ã®ç³–è¡£æ§‹æ–‡ã£ã½ã„

> useCallback(fn, deps) ã¯ useMemo(() => fn, deps) ã¨ç­‰ä¾¡ã§ã™ã€‚
> https://ja.reactjs.org/docs/hooks-reference.html#usecallback

```diff tsx
- import { memo, useCallback, useEffect, useState } from 'react'
+ import { memo, useEffect, useState } from 'react'

-  const handleClick = () => {
-    console.log('Childã®ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚ˆ')
-  }

+  const handleClick = useCallback(() => {
+    console.log('Childã®ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚ˆ')
+  }, [])
```

`useCallback`ã¯`useMemo`ã¨åŒæ§˜(useMemo ã®ç³–è¡£æ§‹æ–‡ã£ã½ã„ã—ãã‚Šã‚ƒãã†ã‹)ã€ç¬¬äºŒå¼•æ•°ã«ä¾å­˜é…åˆ—ã‚’å—ã‘å–ã‚Šã€ä¾å­˜é…åˆ—ã§æŒ‡å®šã—ãŸå€¤ãŒæ›´æ–°ã•ã‚Œã‚‹ã¨ useCallback ã§ãƒ¡ãƒ¢åŒ–ã—ãŸé–¢æ•°ãŒå†è¨ˆç®—ã•ã‚Œã‚‹
çµæœã¨ã—ã¦ã€è¦ªã® state ãŒæ›´æ–°ã•ã‚Œã¦ã‚‚ memo åŒ–ã•ã‚ŒãŸå­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œãªã„
![](https://i.gyazo.com/d48fbaaf1a8330bfdcd2da302ade7f11.gif)

#### useCallback ã™ã‚‹é–¢æ•°ã«å¼•æ•°ãŒã‚ã‚‹å ´åˆã©ã†ã™ã‚Œã°ã„ã„ã®ï¼Ÿ

å˜ã« useCallback ã§æ¸¡ã™é–¢æ•°ã‚’å¼•æ•°ä»˜ãã«ã—ã¦ã‚ã’ã‚Œã°è‰¯ã„

Child ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```diff tsx
type ChildProps = {
  count: number
-  handleClick: () => void
+  handleClick: (text: string) => void
}

      <button
        type="button"
        onClick={() => {
-          handleClick()
+          handleClick('Childã®ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚ˆ')
        }}
      >
```

Parent

```diff tsx
-  const handleClick = useCallback(() => {
+  const handleClick = useCallback((text: string) => {
-    console.log('Childã®ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚ˆ')
+    console.log(text)
  }, [])
```

### userReducer ã¨ memo åŒ–ã‚’çµ„ã¿åˆã‚ã›ãŸã¨ãã®æŒ™å‹•

reducer ã®å®Ÿè£…ã£ã¦ immutable ãªæ°—ãŒã—ã¦ã„ã¦ã€state ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã€ä¸€éƒ¨ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ›´æ–°ã—ãŸã ã‘ã§ã‚‚ä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚‚å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã‚“ã˜ã‚ƒãƒ»ãƒ»ã¨æ€ã£ã¦ãŸã‚‰ãã†ã§ãªã‹ã£ãŸã£ã¦ãŠè©±

reducer å‘¨ã‚Š

```tsx
export type State = {
  count1: number;
  count2: number;
  count3: number;
  count4: number;
};

export const updateCount1 = (
  state: State,
  { value }: UpdateCount1Payload
): State => ({ ...state, count1: value });
// ... updateCount2, updateCount3, updateCount4ãŒç¶šã

export enum ActionType {
  UpdateCount1 = "UpdateCount1",
  // ...
}

export type Action =
  | {
      type: ActionType.UpdateCount1;
      payload: UpdateCount1Payload;
    }
  | {
      type: ActionType.UpdateCount2;
      payload: UpdateCount2Payload;
    };
// ...

export const reducer: Reducer<State, Action> = (state, action) => {
  switch (action.type) {
    case ActionType.UpdateCount1:
      return updateCount1(state, action.payload);
    // ...
    default:
      throw new TypeError(`unexpected action. ${action}`);
  }
};
```

å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```tsx
const Child = ({ count, label }: ChildProps): JSX.Element => {
  useEffect(() => {
    console.log(`Child${label}ãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸã‚ˆ`);
  });

  return (
    <p>
      Child{label}ï¼š{count}
    </p>
  );
};

const ChildMemo = memo<ChildProps>(({ count, label }) => {
  return <Child count={count} label={label} />;
});
```

è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```tsx
import { memo, useCallback, useEffect, useReducer, useState } from "react";
import { ActionType } from "state/action";
import { reducer } from "state/reducer";
import { initialState } from "state";

const Parent: NextPage = () => {
  const [parentCount, setParentCount] = useState<number>(0);
  const [childState, dispatch] = useReducer(reducer, initialState);

  useEffect(() => {
    console.log("ParentãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸã‚ˆ");
  });

  return (
    <div>
      <button
        type="button"
        onClick={() => {
          setParentCount(parentCount + 1);
        }}
      >
        Parent count up
      </button>
      <button
        type="button"
        onClick={() => {
          dispatch({
            type: ActionType.UpdateCount1,
            payload: {
              value: childState.count1 + 1,
            },
          });
        }}
      >
        Child1 count up
      </button>
      {/* count2, count3...ã®å€¤ã‚’ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹ã‚ˆã†ã®ãƒœã‚¿ãƒ³ãŒåŒæ§˜ã«ã‚ã‚‹ */}
      <p>Parentï¼š{parentCount}</p>
      <ChildMemo count={childState.count1} label="01" />
      {/* count2, count3...ã®å€¤ã‚’countã®propã«æ¸¡ã™ChildMemoã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã‚ã‚‹ */}
    </div>
  );
};
```

`Child`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ¡ãƒ¢åŒ–ã—ãŸ`ChildMemo`ã¯ reducer ã§å®šç¾©ã•ã‚ŒãŸ state ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ props ã¨ã—ã¦å—ã‘å–ã£ã¦ã„ã‚‹ã®ã§ã€`setParentCount`ãŒå‘¼ã°ã‚Œã¦è¦ªã® state ãŒæ›´æ–°ã•ã‚Œã¦ã‚‚`Child`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œãªã„
reducer ã§å®šç¾©ã•ã‚ŒãŸ state ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ›´æ–°ã—ãŸå ´åˆã¯ã€ãã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ props ã¨ã—ã¦æ¸¡ã—ã¦ã„ã‚‹`Child`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨`Parent`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã¿å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹

![](https://i.gyazo.com/31a89c641f5a83142a8d7b9bb9cd4585.gif)

## ã¾ã¨ã‚

æ•¬é ã—ã¦ãŸãƒ¡ãƒ¢åŒ–ã ã‘ã©ã‚‚ã€æ‰‹ã‚’å‹•ã‹ã—ã¦å®Ÿè£…ã—ã¦ã¿ã‚‹ã¨æ„å¤–ã¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ããŸã‹ã‚‰ãƒ¨ã‚­ã§ã—ãŸ
