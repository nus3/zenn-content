---
title: "Storybookのデプロイ先をNetlifyからS3に移管した話"
emoji: "🤠"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["nuxtjs", "typescript", "aws cdk", "circleCI", "s3"]
published: false
---

## 未整理

### CDK で書くこと

- S3 のバケットは CDK で書いた
- aws s3 sync に必要な actions`["s3:ListBucket", "s3:PutObject", "s3:GetBucketAcl"]`
- resource の指定方法
  - [`arn:aws:s3:::${config.bucketName}`,`arn:aws:s3:::${config.bucketName}/*`],
- ライフサイクルの指定
- `fatal error: An error occurred (AccessDenied) when calling the ListObjectsV2 operation: Access Denied`の時の対応
  - ちゃんと action が付与されているか
  - resource が正しいか
  - デプロイに使われてる aws アカウントの key に紐づいてるポリシーを確認しよう
- [s3 のアクセスコントロールまわり](https://qiita.com/ryo0301/items/791c0a666feeea0a704c)
  - principals
  - acl
  - バケットポリシー
- aws cdk でいじれるプロパティまわり
- 静的ホスティング対応(CDK で書く場合)
  - websiteIndexDocument を指定すればよきかな

### circleci で書くこと

- orbs aws-s3/sync の`to`には環境変数は使えない
- 生成ディレクトリは gitkeep する
- ブランチ名を取得する
- persist_to_workspace は`/tmp/workspace`にする
- `fatal error: An error occurred (AccessDenied) when calling the ListObjectsV2 operation: Access Denied`の時の対応
  - デプロイに使われてる aws アカウントの key に紐づいてるポリシーを確認しよう
- aws コマンドはローカルで叩いてみてもいいかも
- コンテナの動作確認方法
