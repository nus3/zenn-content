---
title: "Storybookã®ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã‚’Netlifyã‹ã‚‰S3ã«ç§»ç®¡ã—ãŸè©±"
emoji: "ğŸ¤ "
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nuxtjs", "typescript", "AwsCdk", "circleCI", "s3"]
published: true
---

## ã‚´ãƒ¼ãƒ«

é™çš„ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãŒã•ã‚ŒãŸ S3 ã« storybook ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„

## èƒŒæ™¯

storybook ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã« netlify ã‚’ä½¿ã£ã¦ã„ãŸãŒã€ãƒ“ãƒ«ãƒ‰æ™‚é–“ãŒå¢—ãˆã‚‹ã«ã¤ã‚Œç„¡æ–™æ ã§ã¾ã‹ãªã„ãã‚Œãªããªã‚Šã€ã‚ˆã‚Šå®‰ä¾¡ãªæ§‹æˆã‚’æ±‚ã‚ã€S3 ã«è¡Œãç€ã„ãŸã€‚ã¤ã„ã§ã«ã©ã†ã›ãªã‚‰ AWS CDK(TypeScript)ä½¿ã£ã¦ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ã‚³ãƒ¼ãƒ‰åŒ–ã™ã‚‹ã€‚

## ã‚µãƒ³ãƒ—ãƒ«

https://github.com/nus3/p-s3-storybook

## ä½œæ¥­å†…å®¹

1. Nuxt create-nuxt-app
2. Storybook ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
3. AWS CDK ã®å®Ÿè£…
4. circleci ã®è¨­å®š

## ãƒã‚¤ãƒ³ãƒˆ

æœ€è¿‘ãƒãƒã£ã¦ã‚‹ã“ã¨ã‚„ã€è©°ã¾ã‚Šãã†ãªç®‡æ‰€ãªã©

### .yarnrc ã¨ .node-version

yarnrc ã§`save-prefix ""`ã‚’è¿½åŠ ã—ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å›ºå®šã™ã‚‹
ã¾ãŸ node-version ã‚‚æŒ‡å®šã—ãŸã’ã‚‹

### Nuxt ã« src ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¿½åŠ ã™ã‚‹

æ™®é€šã« create-nuxt-app ã™ã‚‹ã¨ root ç›´ä¸‹ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå¤§é‡ã«ã§ãã‚‹ã®ã§ src ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã™ã‚‹
[ã“ã“ã‚‰è¾ºãŒè©²å½“](https://github.com/nus3/p-s3-storybook/commit/38c331f73c0b8ce8b5c60ee8f76d7c2852040112)

### storybook ã‚’æ‰‹å‹•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

å…¬å¼ã«æ›¸ã„ã¦ã‚ã‚‹`npx sb init`ã§ã‚‚è‰¯ã„ã‚“ã ã‘ã©ã‚‚ scss èª­ã¿è¾¼ã‚“ã ã‚Šã€typescript ã® stories ã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã®è¨­å®šã«å¤‰ãˆã‚‹ã®ãŒé¢å€’ã ã£ãŸã®ã§æ‰‹å‹•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ä¸€å¿œ[typescript ç”¨ã® addon](https://github.com/storybookjs/presets/blob/master/examples/ts-vue/.storybook/main.ts)ã‚‚ã‚ã‚‹ã£ã½ã„

[ã“ã“ã‚‰è¾ºãŒè©²å½“](https://github.com/nus3/p-s3-storybook/commit/4706b246a263f994843a22dc5d6c462dab7a1db5)
[ä»¥å‰æ›¸ã„ãŸã‚„ã¤(storybook ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤ã„ã®ã§ãŠæ°—ã‚’ã¤ã‘ãã ã•ã„)](https://qiita.com/yotahada-nus3/items/e19581986eb8aeeddae1#storybook-%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB)

vue ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«`vue-shim.d.ts`ã®è¿½åŠ 

```typescript
declare module "*.vue" {
  import Vue from "vue";

  export default Vue;
}
```

### CDK ã§ s3bucket ã®ä½œæˆ

```typescript:cdk-stack.ts
const bucket: s3.Bucket = new s3.Bucket(this, config.name, {
  versioned: false,
  bucketName: config.bucketName,
  // é™çš„ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã®ãŸã‚ã®è¨­å®š
  publicReadAccess: true,
  removalPolicy: cdk.RemovalPolicy.DESTROY,
  // storybookã®ç¢ºèªã®ãŸã‚ã ã‘ãªã®ã§ä¿å­˜æœŸé–“ã¯2é€±é–“ãã‚‰ã„ã«è¨­å®š
  lifecycleRules: [
    {
      expiration: Duration.days(14),
      prefix: "branches/",
    },
  ],
  // é™çš„ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã®ãŸã‚ã®è¨­å®š
  websiteIndexDocument: "index.html",
});

// ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã« aws s3 sync ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã®ã«å¿…è¦ãªæ¨©é™ã¾ã‚ã‚Š
const policyStatement: iam.PolicyStatement = new iam.PolicyStatement({
  effect: iam.Effect.ALLOW,
  actions: ["s3:ListBucket", "s3:PutObject", "s3:GetBucketAcl"],
  resources: [
    `arn:aws:s3:::${config.bucketName}`,
    `arn:aws:s3:::${config.bucketName}/*`,
  ],
  principals: [new iam.AccountPrincipal(context.iam)],
});
bucket.addToResourcePolicy(policyStatement);
```

[ã“ã“ã‚‰è¾ºãŒè©²å½“](https://github.com/nus3/p-s3-storybook/commit/eb82de80fa3f9f7ad4dc5ca3be4ed52b2005b78f)

### circleCI ã®è¨­å®š

ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰`/`ã‚’`_`ã«å¤‰æ›ã—ã¦ãƒã‚±ãƒƒãƒˆã®`branches/`é…ä¸‹ã®`{branch_name}/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ“ãƒ«ãƒ‰ã—ãŸ storybook ã®ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹

```yaml
- run:
    name: Deploy to S3
    command: |
      branch=$(echo $CIRCLE_BRANCH | sed s#/#\_#g)
      aws s3 sync ./storybook-static/ "s3://$STORYBOOK_BUCKET_NAME/branches/$branch" \
        --delete
```

[ã“ã“ã‚‰è¾ºãŒè©²å½“](https://github.com/nus3/p-s3-storybook/commit/64cdf25a17bc7fa917031326a5661965dfefdecb)

ãƒ“ãƒ«ãƒ‰å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ã‚’ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã”ã¨ gitignore ã—ã¦ã—ã¾ã†ã¨ circleCI ã§ã®ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œä¸­ã«ãƒ“ãƒ«ãƒ‰å¾Œã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãªã„ã‚ˆã£ã¦æ€’ã‚‰ã‚Œã‚‹ã®ã§ gitignore ã®è¨­å®šã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã¿æ®‹ã™ã‚ˆã†ã«è¨­å®šã™ã‚‹

```
storybook-static/*
!storybook-static/.gitkeep
```

## ã‚ã¨ãŒã

å…¬é–‹ã•ã‚ŒãŸ storybook ã« basic èªè¨¼ã‹ã‘ãŸããªã£ãŸã‚‰
å˜ç´”ãª s3 ã®é™çš„ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã§ã¯ãªã cloud front ä½¿ã£ãŸæ–¹ãŒè‰¯ã•ã’
