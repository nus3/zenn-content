---
title: "Amplifyã‚’ä½¿ãˆã°5åˆ†ã§Next.jsç’°å¢ƒã‚’å…¬é–‹ã§ãã¡ã‚ƒã†"
emoji: "ğŸ˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs", "amplify"]
published: true
---

## ã¯ã˜ã‚ã«

ã¯ã„ã€è©æ¬ºã‚¿ã‚¤ãƒˆãƒ«ã§ã™
ä½•ã‚‚çŸ¥ã‚‰ãªã„çŠ¶æ…‹ã‹ã‚‰ [Amplify](https://aws.amazon.com/jp/amplify/) ã‚’ä½¿ã£ã¦ Next.js ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã®ã«[ç§ã¯ 1 æ—¥åŠã»ã©è²»ã‚„ã—ã¾ã—ãŸ](https://zenn.dev/nus3/scraps/187e60335c26ae)
ãŸã ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¾ã§ã«ã„ãã¤ã‹ã‚ã‚‹ã¤ã¾ã¥ããƒã‚¤ãƒ³ãƒˆã‚’è¶…ãˆã‚‹ã¨ã»ã‚“ã¨ã«ç°¡å˜ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦å…¬é–‹ã§ãã‚‹ã®ã§ã€ãã®ã¤ã¾ã¥ããƒã‚¤ãƒ³ãƒˆã‚’ã”ç´¹ä»‹ã§ãã‚Œã°

## è¨˜äº‹ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ

- S3 + CloudFront ã« Next.js ç’°å¢ƒã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„äºº
- Amplify ä½¿ã£ã¦ã¿ãŸã„äºº
- Amplify ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ ã¯ GitHub é€£æºã˜ã‚ƒãªãã¦ CLI ä½¿ã£ã¦æ‰‹å‹•ã§ã—ãŸã„äºº

## æ¦‚è¦

ãªã‚“ã¨! ä»Šãªã‚‰!! ãŸã£ãŸã® 5 ã‚¹ãƒ†ãƒƒãƒ—ã§!!!

1. Amplify CLI ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
2. ãƒ‡ãƒ—ãƒ­ã‚¤æ¨©é™ãŒã‚ã‚‹ IAM ã®ä½œæˆ
3. `amplify init`
4. `amplify add hosting`
5. `amplify publish`

## ç’°å¢ƒ

é–¢ä¿‚ã‚ã‚Šãã†ãªã®ã ã‘
`@aws-amplify/cli`ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã¾ã™

```json
"@aws-amplify/cli": "4.41.2",
"next": "10.0.6",
"react": "17.0.1",
"react-dom": "17.0.1",
"typescript": "4.1.3",
```

Next.js ã¯ CSR ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å‰æã§ã™

## ã„ã–å‚ã‚‹

### 1. Amplify CLI ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

`npm install -g @aws-amplify/cli`ã—ã¦ AmplifyCLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

#### ã¤ã¾ã¥ããƒã‚¤ãƒ³ãƒˆ 1

:::message
yarn ã§ `@aws-amplify/cli`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãªã„
:::

æœ€åˆã« amplify ã®è¨­å®šã‚’ã™ã‚‹ã®ã«`amplify init`ã‚’ã™ã‚‹éš›ã«
è‡ªåˆ†ã®ãƒªãƒã‚¸ãƒˆãƒªé…ä¸‹ã«`@aws-amplify/cli`ã‚’ yarn ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚‰[ã†ã¾ãã„ã‹ãªã‹ã£ãŸ](https://zenn.dev/nus3/scraps/187e60335c26ae#comment-1b83adfc89d648)

`amplify init`ã®è¨­å®šä¸­ã«ä¸‹è¨˜ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹
`(node:98501) UnhandledPromiseRejectionWarning: TypeError: Cannot read property 'value' of undefined`

issue ã‚’èª­ã¿æ¼ã‚‹ã¨`npm install -g @aws-amplify/cli`ã—ã¦ã­ã¨ã®ã“ã¨
https://github.com/aws-amplify/amplify-cli/issues/839#issuecomment-618474964

### 2. ãƒ‡ãƒ—ãƒ­ã‚¤æ¨©é™ãŒã‚ã‚‹ IAM ã®ä½œæˆ

ä»Šå›ã¯äº‹å‰ã«ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã® IAM ãŒç”¨æ„ã•ã‚Œã¦ã„ãŸã®ã§ã‚„ã£ã¦ã„ãªã„ãŒ
`amplify configure`ã™ã‚‹ã¨ã„ãã¤ã‹ aws console ã‹ã‚‰ AdministratorAccess æ¨©é™ã‚’æŒã£ãŸ User ã‚’ä½œæˆã—ã¦ãã‚Œã‚‹è¦ªåˆ‡è¨­è¨ˆ
https://docs.amplify.aws/cli/start/install#configure-the-amplify-cli

### 3. `amplify init`

Amplify App ã‚’ä½œã‚‹ãŸã‚ã®åˆå›è¨­å®š
å®Ÿè¡Œã™ã‚‹ã¨ CLI ä¸Šã§è¨­å®šã«å¿…è¦ãªæƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ãªã£ã¦ã‚‹

```bash
â¯ amplify init
Initializing new Amplify CLI version...
Done initializing new version.
Scanning for plugins...
Plugin scan successful
Note: It is recommended to run this command from the root of your app directory
? Enter a name for the project {ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå}
? Enter a name for the environment dev
? Choose your default editor: Visual Studio Code
? Choose the type of app that you're building javascript
Please tell us about your project
? What javascript framework are you using react
? Source Directory Path:  src
? Distribution Directory Path: out
? Build Command:  yarn build
? Start Command: yarn start
Using default provider  awscloudformation
? Do you want to use an AWS profile? No
? accessKeyId:  ***
? secretAccessKey:  ***
? region:  ap-northeast-1
```

accessKey ã¨ secretAccessKey ã¯ãƒ‡ãƒ—ãƒ­ã‚¤æ¨©é™ã‚’æŒã£ã¦ã‚‹ã‚„ã¤

ç„¡äº‹ã«çµ‚ã‚ã‚‹ã¨ãƒ«ãƒ¼ãƒˆç›´ä¸‹ã«`amplify`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç”Ÿæˆã•ã‚Œã‚‹

#### ã¤ã¾ã¥ããƒã‚¤ãƒ³ãƒˆ 2

:::message
S3 ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ã‚ˆã†ã« Next.js ã®è¨­å®šã‚’å¤‰ãˆã‚‹ã‚“ã‚„
:::

Next.js ã‚’ S3 ã®é™çš„ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°(or CloudFront ã§ CDN é…ä¿¡)ã™ã‚‹ã«ã¯ build æ™‚ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å¤‰ãˆã¨ã
ä¸‹è¨˜ã®ã‚ˆã†ã« build ã‚³ãƒãƒ³ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ã¨ build ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒ`/out`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç”Ÿæˆã•ã‚Œã‚‹

```json:package.json
"scripts": {
  "build": "next build && next export",
},
```

### 4. `amplify add hosting`

ã©ã®ã‚ˆã†ã«ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹ã‹è¨­å®šã™ã‚‹

```bash
â¯ amplify add hosting

? Select the plugin module to execute: Hosting with Amplify Console
? Choose a type: Manual deployment
```

ç„¡äº‹ã«çµ‚ã‚ã‚‹ã¨`amplify/backend/hosting/amplifyhosting`ãŒè¿½åŠ ã•ã‚Œã‚‹

#### ã¤ã¾ã¥ããƒã‚¤ãƒ³ãƒˆ 3

:::message
**`Select the plugin module to execute`ã§äºŒã¤ã®é¸æŠè‚¢ãŒå‡ºã¦ãã‚‹ãŒã€`Hosting with Amplify Console` ã‚’é¸ã¶ã‚“ã‚„**
:::

```bash
â¯ Hosting with Amplify Console (Managed hosting with custom domains, Continuous deployment)
  Amazon CloudFront and S3
```

ãˆã€å½“ãŸã‚Šå‰ã®ã‚ˆã†ã«`Amazon CloudFront and S3`ä½¿ã†ã‚“ã—ã‚‡ã£ã¦æ€ã£ã¦ãã£ã¡é¸ã¶ã¨[AccessDenied ã®å£ã‚’è¶…ãˆã‚‰ã‚Œãš](https://zenn.dev/nus3/scraps/187e60335c26ae#comment-12c5fa25a84599)
ã§ããŸ CloudFront ã‚„ S3 ã®ãƒã‚±ãƒƒãƒˆã®ä¸­ã‚’è¦‹ã‚‹æ„Ÿã˜ã€ã†ã¾ãã§ãã¦ã‚‹ã¯ãšãªã‚“ã ã‘ã©ãƒ»ãƒ»

TODO: Amazon CloudFront and S3 ã§ã‚‚å…¬é–‹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

### `amplify publish`

`amplify publish`ã§è¨­å®šã—ãŸå†…å®¹ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã‚Œã‚‹

## ç•ªå¤–ç·¨: CICD ã«çµ„ã¿è¾¼ã¿ãŸã„(CircleCI ç·¨)

1. `amplify init`ã‚’ Headless mode ã§å®šç¾©ã™ã‚‹
2. local ã§`amplify init`ã™ã‚‹
3. local ã§`amplify add hosting`ã™ã‚‹
4. `config.yml`ã«ãƒ‡ãƒ—ãƒ­ã‚¤ step ã‚’è¿½åŠ ã™ã‚‹

### 1. `amplify init`ã‚’ Headless mode ã§å®šç¾©ã™ã‚‹

CICD ã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã« [Headless mode](https://docs.amplify.aws/cli/usage/headless) ãªã‚‹ã‚‚ã®ãŒ Amplify CLI ã«ã¯ã‚ã‚‹
[ã‚µãƒ³ãƒ—ãƒ«ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‚‚ã®](https://docs.amplify.aws/cli/usage/headless#sample-script)ã‚’ shell ã§å®šç¾©ã—ãŸ

```shell:/scripts/amplify_init/main.sh
#!/bin/sh

set -e
IFS='|'

ACCESS_KEY=""
SECRET_KEY=""

usage () {
  cat <<EOM
Usage: $(basename "$0") [OPTION]...
  -h               Display help
  -a ACCESS_KEY    Access key of AWS
  -s SECRET_KEY    secret key of AWS
EOM

  exit 2
}

while getopts "a:s:h" OPT
do
  case $OPT in
    "a" ) ACCESS_KEY="$OPTARG";;
    "s" ) SECRET_KEY="$OPTARG";;
    '-h'|'--help'|* ) usage ;;
  esac
done

REACTCONFIG="{\
\"SourceDir\":\"src\",\
\"DistributionDir\":\"out\",\
\"BuildCommand\":\"yarn build\",\
\"StartCommand\":\"yarn start\"\
}"
AWSCLOUDFORMATIONCONFIG="{\
\"configLevel\":\"project\",\
\"useProfile\":false,\
\"profileName\":\"default\",\
\"accessKeyId\":\"$ACCESS_KEY\",\
\"secretAccessKey\":\"$SECRET_KEY\",\
\"region\":\"ap-northeast-1\"\
}"
# project-nameã«ã¯ä»»æ„ã®projectå
AMPLIFY="{\
\"projectName\":\"project-name\",\
\"envName\":\"dev\",\
\"defaultEditor\":\"code\"\
}"
FRONTEND="{\
\"frontend\":\"javascript\",\
\"framework\":\"react\",\
\"config\":$REACTCONFIG\
}"
PROVIDERS="{\
\"awscloudformation\":$AWSCLOUDFORMATIONCONFIG\
}"

amplify init \
--amplify $AMPLIFY \
--frontend $FRONTEND \
--providers $PROVIDERS \
--yes
```

ã»ã¼ã‚„ã£ã¦ã‚‹ã“ã¨ã¯ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¨ä¸€ç·’ã ãŒ AWS ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã‚’ CircleCI ã® Context ã‹ã‚‰å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«å¼•æ•°ã§ã‚‚ã‚‰ã£ã¦ã‚‹

### 2. `amplify init`ã¨`amplify add hosting`

å‰æ®µã§è¨˜è¼‰ã—ãŸé€šã‚Š
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¨­å®šæƒ…å ±ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§å¿…ãšä¸€åº¦å®Ÿè¡Œã™ã‚‹
`amplify init`ã«é–¢ã—ã¦ã¯å®šç¾©ã—ãŸ shell ã‚’å®Ÿè¡Œã™ã‚Œã°è‰¯ã

### `config.yml`ã«ãƒ‡ãƒ—ãƒ­ã‚¤ step ã‚’è¿½åŠ ã™ã‚‹

```yml
deploy_stg:
  executor: default
  steps:
    - checkout
    - attach_workspace:
        at: .
    - run:
        name: Install amplify cli
        command: curl -sL https://aws-amplify.github.io/amplify-cli/install | bash && $SHELL
    - run:
        name: Update path
        command: echo 'export PATH="$HOME/.amplify/bin:$PATH"' >> $BASH_ENV
    - run:
        name: Init amplify
        # contextã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã¯å–å¾—ã™ã‚‹
        command: sh scripts/amplify_init/main.sh -a "$AWS_ACCESS_KEY_ID" -s "$AWS_SECRET_ACCESS_KEY"
    - run:
        name: Deploy
        command: amplify publish --yes
```

#### ã¤ã¾ã¥ããƒã‚¤ãƒ³ãƒˆ 4

:::message
Amplify cli ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯`curl -sL https://aws-amplify.github.io/amplify-cli/install | bash && $SHELL`ã‚„ã
ã‚ã¨ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸå¾Œã¯ path é€šã™ã‚“ã‚„ã§
:::

#### ã¤ã¾ã¥ããƒã‚¤ãƒ³ãƒˆ 5

:::message
`image: cimg/node:14.15.4`ã‚’ä½¿ã£ã¦ã‚‹ã¨ Next ã® build ãŒã“ã‘ã‚‹ã‹ã‚‰
`yarn add sharp`ã—ã¨ã
:::

`cimg/node:14.15.4`ã®ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ build ã™ã‚‹ã¨ä¸‹è¨˜ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã‚’åã

```
> Build error occurred
Error: Cannot find module 'sharp'
Require stack:
- /home/circleci/src/node_modules/next/dist/build/index.js
- /home/circleci/src/node_modules/next/dist/cli/next-build.js
- /home/circleci/src/node_modules/next/dist/bin/next
    at Function.Module._resolveFilename (internal/modules/cjs/loader.js:880:15)
    at Function.resolve (internal/modules/cjs/helpers.js:94:19)
    at /home/circleci/src/node_modules/next/dist/build/index.js:11:1029
    at /home/circleci/src/node_modules/next/dist/build/tracer.js:1:1331
    at NoopTracer.withSpan (/home/circleci/src/node_modules/@opentelemetry/api/build/src/trace/NoopTracer.js:47:16)
    at ProxyTracer.withSpan (/home/circleci/src/node_modules/@opentelemetry/api/build/src/trace/ProxyTracer.js:36:34)
    at traceFn (/home/circleci/src/node_modules/next/dist/build/tracer.js:1:1301)
    at /home/circleci/src/node_modules/next/dist/build/index.js:11:365
    at async /home/circleci/src/node_modules/next/dist/build/tracer.js:1:1441 {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/home/circleci/src/node_modules/next/dist/build/index.js',
    '/home/circleci/src/node_modules/next/dist/cli/next-build.js',
    '/home/circleci/src/node_modules/next/dist/bin/next'
  ]
}
error Command failed with exit code 1.
```

`yarn add sharp`ã›ãˆã‚ˆã¨ã®ã“ã¨
https://github.com/vercel/next.js/blob/canary/errors/install-sharp.md

## ç•ªå¤–ç·¨: Amplify ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¯ Basic èªè¨¼ãŒã‚ã£ã¡ã‚ƒæ¥½

Cloud Front + S3 ç’°å¢ƒã ã¨ Cloud Front å´ã§ Basic èªè¨¼ã®è¨­å®šã™ã‚‹ã‚ˆã†ãª Lambda ã‚’å®Ÿè£…ã—ã¦ãŸã‘ã©ã€Amplify ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã¯ç”»é¢ã½ã¡ã½ã¡ã§ã™ã Basic èªè¨¼ã§ãã‚‹
![](https://storage.googleapis.com/zenn-user-upload/95fexs01pi7336x5698wzggyrwt0)
